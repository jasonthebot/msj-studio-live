<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>msj-studio • Phase Beta</title>
  <style>
    :root {
      --bg:#0b0d12;--panel:#11151d;--panel-2:#161b25;--text:#edf1f8;--muted:#97a1b5;
      --accent:#7aa2ff;--border:#252d3a;--danger:#ff7f8f;--ok:#63d6a2;
      --canvas:#0b1018;--card:#151d2a;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(circle at 20% -20%,#19253a,var(--bg) 43%);color:var(--text);font-family:Inter,system-ui,sans-serif}
    .layout{display:grid;grid-template-columns:minmax(860px,1fr) 360px;min-height:100vh}
    .canvas-wrap{padding:16px;position:relative}
    .device-switch{position:fixed;left:18px;bottom:18px;z-index:11;background:#111722;border:1px solid var(--border);border-radius:12px;padding:6px;display:flex;gap:6px}
    .device-switch button{font-size:.76rem;padding:7px 10px;transition:all .2s ease}
    .device-switch button.active{background:#24324d;border-color:#3b5588}
    .canvas-shell{border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#0e131c,#0b1017);overflow:hidden;min-height:calc(100vh - 32px)}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);background:rgba(9,12,18,.94);position:sticky;top:0;z-index:8}
    .group{display:inline-flex;gap:8px;align-items:center;padding-right:10px;border-right:1px solid #202838}
    .group:last-child{border-right:0}
    .group.secondary{opacity:.8}
    .group.secondary button,.group.secondary select{background:#121926;color:#c7d0e2;border-color:#2a3448}
    .group.primary-actions{margin-left:auto;padding:6px;background:#131d2c;border:1px solid #2e4269;border-radius:11px;box-shadow:0 8px 24px #00000035}
    .hint{font-size:.72rem;color:#9fb0ce;padding:1px 6px;border:1px solid #354866;border-radius:999px}
    button,select,input,textarea{background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:9px;padding:7px 9px;font:inherit}
    button{cursor:pointer;transition:all .18s ease}
    button:hover{border-color:var(--accent)}
    button.primary{background:linear-gradient(180deg,#2a3a5f,#1f2e4d);border-color:#3c538f}
    button.danger{border-color:#603540;color:#ffbcc4}
    #status{color:var(--muted);font-size:.82rem;min-width:100px;text-align:right}
    #status.ok{color:var(--ok)}
    .preview-wrap{padding:20px;background:var(--canvas);display:flex;justify-content:center;min-height:calc(100vh - 92px)}
    .preview-frame{width:min(100%,1200px);transition:width .2s ease,transform .2s ease,opacity .2s ease}
    .preview-frame.switching{transform:translateY(4px) scale(.994);opacity:.9}
    .preview-frame[data-device="tablet"]{width:min(100%,860px)}
    .preview-frame[data-device="mobile"]{width:min(100%,430px)}
    .site{background:#0e131b;border:1px dashed #202a3a;border-radius:14px;overflow:hidden}
    .blk{border:1px solid #26324755;position:relative;transition:border-color .16s ease,box-shadow .16s ease,transform .16s ease}
    .blk:hover{border-color:#3a4c6d88}
    .blk.sel{border-color:#7aa2ff;box-shadow:0 0 0 1px #7aa2ff80,0 0 0 3px #7aa2ff26 inset;transform:translateY(-1px)}
    .blk-tools{position:absolute;top:6px;right:6px;z-index:4;display:flex;gap:4px;background:#101725d9;padding:4px;border-radius:8px;border:1px solid #2a3346}
    .blk-tools button{padding:2px 6px;font-size:.72rem}
    .ed{outline:none}
    .ed:focus{box-shadow:0 0 0 2px #7aa2ff60;border-radius:6px}
    .sidebar{border-left:1px solid var(--border);padding:14px;background:#10131a;display:flex;flex-direction:column;gap:10px}
    .inspector-title{margin:0 0 2px;color:#c8d4eb;font-size:.78rem;text-transform:uppercase;letter-spacing:.14em;font-weight:700}
    .card{border:1px solid var(--border);background:#121824;border-radius:12px;padding:13px 12px;margin:0}
    .card.sticky{position:sticky;top:10px;z-index:6;background:#152032;border-color:#334765}
    .section-title{margin:0 0 11px;color:#b6c3da;font-size:.74rem;text-transform:uppercase;letter-spacing:.1em;font-weight:700}
    .field{margin-bottom:12px}
    .field:last-child{margin-bottom:0}
    .field label{display:block;color:var(--muted);font-size:.8rem;margin-bottom:5px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .mini{font-size:.78rem;color:var(--muted);line-height:1.45}
    .chip{padding:2px 8px;background:#1b2434;border:1px solid var(--border);border-radius:999px;font-size:.73rem}
    .hide{display:none}
    @media (max-width:1200px){.layout{grid-template-columns:1fr}.sidebar{border-left:0;border-top:1px solid var(--border)}}
  </style>
</head>
<body>
  <div class="layout">
    <div class="canvas-wrap">
      <div class="canvas-shell">
        <div class="toolbar">
          <div class="group secondary">
            <select id="addBlock" title="Add a new block">
              <option value="">+ Add block</option>
              <option value="header">Header/Nav</option><option value="hero">Hero</option><option value="text">Text</option>
              <option value="image">Image</option><option value="split">Split</option><option value="gallery">Gallery</option><option value="footer">Footer</option>
            </select>
            <select id="templatePick" title="Switch template"><option value="">Templates</option><option value="saas">SaaS</option><option value="portfolio">Portfolio</option><option value="landing">Landing</option></select>
          </div>
          <div class="group secondary">
            <button id="undo" title="Undo">Undo</button><button id="redo" title="Redo">Redo</button>
            <button id="copyBtn" title="Copy exported HTML">Copy export</button>
          </div>
          <div class="group primary-actions">
            <button id="save" class="primary" title="Save project (⌘/Ctrl+S)">Save <span class="hint">⌘/Ctrl+S</span></button>
            <button id="publishBtn" title="Publish current snapshot">Publish</button>
            <button id="exportBtn" title="Export HTML/CSS bundle">Export</button>
            <button id="modeBtn" title="Toggle draft/published mode">Mode: Draft</button>
          </div>
          <div id="status">Ready</div>
        </div>
        <div class="preview-wrap"><div class="preview-frame" id="previewFrame" data-device="desktop"><div class="site" id="site"></div></div></div>
      </div>
      <div class="device-switch">
        <button data-d="desktop">Desktop</button><button data-d="tablet">Tablet</button><button data-d="mobile">Mobile</button>
      </div>
    </div>
    <aside class="sidebar">
      <h3 class="inspector-title">Inspector</h3>
      <div class="card sticky">
        <h4 class="section-title">Editing scope</h4>
        <div class="field"><label><input id="applyAllDevices" type="checkbox" checked> Apply to all devices</label></div>
        <div class="mini">Turn off to edit Tablet/Mobile styles independently for selected blocks.</div>
      </div>
      <div class="card">
        <h4 class="section-title">SEO</h4>
        <div class="field"><label>SEO title</label><input id="seoTitle"/></div>
        <div class="field"><label>Meta description</label><textarea id="seoDesc" rows="2"></textarea></div>
        <div class="field"><label>OG image URL</label><input id="seoOg"/></div>
      </div>
      <div class="card">
        <h4 class="section-title">Global style scale</h4>
        <div class="row2">
          <div class="field"><label>Type scale</label><input id="gType" type="number" step="0.05" min="0.7" max="1.5"></div>
          <div class="field"><label>Spacing</label><input id="gSpace" type="number" step="0.05" min="0.7" max="1.8"></div>
          <div class="field"><label>Max width</label><input id="gMax" type="number" min="760" max="1440"></div>
          <div class="field"><label>Radius</label><input id="gRadius" type="number" min="0" max="40"></div>
        </div>
        <div class="field"><label><input id="gShadow" type="checkbox"> soft shadows</label></div>
      </div>
      <div class="card" id="blockCard"><h4 class="section-title">Selected block</h4><p class="mini">Pick a block to edit content/style.</p></div>
      <div class="card">
        <div class="mini">Device editing: switch Desktop/Tablet/Mobile (bottom-left). Duplicate selected block with <strong>⌘/Ctrl+D</strong>.</div>
      </div>
    </aside>
  </div>
<script>
const STORE='msj_beta_v1';
const deep=v=>JSON.parse(JSON.stringify(v));
const uid=()=>crypto.randomUUID();
const initial=()=>({
  mode:'draft',device:'desktop',selected:null,
  seo:{title:'msj-studio site',description:'Built in msj-studio',og:''},
  global:{typeScale:1,spacing:1,maxWidth:1120,radius:14,shadow:true},
  published:null,
  blocks:[mk('header'),mk('hero'),mk('text'),mk('footer')]
});
function mk(type){
  const base={id:uid(),type,linkStyles:true,style:{global:{bg:'#111722',fg:'#edf1f8',pad:24,align:'left',radius:12,fit:'cover',imgW:100},tablet:{},mobile:{}}};
  if(type==='header')return {...base,content:{logo:'MSJ',title:'msj-studio',titleOn:true,logoPos:'left',links:'Features,Pricing,Docs',cta:'Get Started'}};
  if(type==='hero')return {...base,content:{preset:'split-right',headline:'Build sites at speed',sub:'Dark minimal builder with local-first flow.',btn:'Start now',img:''}};
  if(type==='text')return {...base,content:{title:'Section title',body:'Write your copy here.',align:'left'}};
  if(type==='image')return {...base,content:{src:'',alt:'',caption:'',align:'center'}};
  if(type==='split')return {...base,content:{title:'Split block',body:'Text and media side by side.',src:'',swap:false}};
  if(type==='gallery')return {...base,content:{items:[]}};
  if(type==='footer')return {...base,content:{logo:'MSJ',text:'© 2026 msj-studio',social:'X,GitHub,LinkedIn',cols:'Product|About|Contact'}};
}
let state=load()||initial();
let history=[]; let future=[]; let autosave;
function load(){try{return JSON.parse(localStorage.getItem(STORE))}catch{return null}}
function persist(silent=true){localStorage.setItem(STORE,JSON.stringify(state));status(silent?'Autosaved':'Saved local ✅', 'ok');}
function status(t,c=''){const e=document.getElementById('status');e.textContent=t;e.className=c;}
function pushHist(){history.push(JSON.stringify(state)); if(history.length>80)history.shift(); future=[];}
function queue(){clearTimeout(autosave);status('Editing…');autosave=setTimeout(()=>persist(true),450)}
function blocksActive(){return state.mode==='draft'?state.blocks:(state.published?.blocks||state.blocks)}
function styleFor(b){const g=b.style.global||{}; if(b.linkStyles)return g; return {...g,...(b.style[state.device]||{})}}
function updateStyle(b,key,val){if(b.linkStyles||state.device==='desktop') b.style.global[key]=val; else {b.style[state.device]=b.style[state.device]||{}; b.style[state.device][key]=val;}}
function esc(s=''){return s.replace(/[&<>\"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]))}

function render(){
  document.getElementById('previewFrame').dataset.device=state.device;
  const site=document.getElementById('site');
  site.style.maxWidth=state.global.maxWidth+'px'; site.style.margin='0 auto';
  const arr=blocksActive();
  site.innerHTML=arr.map((b,i)=>renderBlock(b,i)).join('');
  bindInline(); syncInspector(); syncDeviceButtons();
}
function renderBlock(b,i){
  const s=styleFor(b), sh=state.global.shadow?'box-shadow:0 10px 25px #00000040;':'';
  const common=`background:${s.bg};color:${s.fg};padding:${(s.pad||22)*state.global.spacing}px;border-radius:${state.global.radius}px;${sh};text-align:${s.align||'left'};margin:12px;`;
  let html='';
  if(b.type==='header'){
    const links=b.content.links.split(',').map(x=>`<span class='chip'>${esc(x.trim())}</span>`).join('');
    html=`<div style='display:flex;align-items:center;justify-content:space-between;gap:12px;flex-direction:${b.content.logoPos==='center'?'column':'row'}'>
      <div style='display:flex;align-items:center;gap:8px'><strong>${esc(b.content.logo)}</strong>${b.content.titleOn?`<span>${esc(b.content.title)}</span>`:''}</div>
      <div style='display:flex;gap:7px;flex-wrap:wrap'>${links}<button>${esc(b.content.cta)}</button></div></div>`;
  }
  if(b.type==='hero'){
    const img=b.content.img?`<img src='${esc(b.content.img)}' style='width:100%;max-height:320px;object-fit:${s.fit||'cover'};border-radius:${state.global.radius}px'>`:'';
    const text=`<div><h1 class='ed' contenteditable='${state.mode==='draft'}' data-f='headline' data-id='${b.id}' style='font-size:${2.1*state.global.typeScale}rem;margin:0 0 8px'>${esc(b.content.headline)}</h1><p class='ed' contenteditable='${state.mode==='draft'}' data-f='sub' data-id='${b.id}'>${esc(b.content.sub)}</p><button>${esc(b.content.btn)}</button></div>`;
    if(b.content.preset==='background'&&b.content.img) html=`<div style='background:url(${esc(b.content.img)}) center/cover;padding:40px;border-radius:${state.global.radius}px'>${text}</div>`;
    else html=`<div style='display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:center'>${b.content.preset==='split-left'?img+text:text+img}</div>`;
  }
  if(b.type==='text') html=`<h2 class='ed' contenteditable='${state.mode==='draft'}' data-f='title' data-id='${b.id}' style='margin:0 0 8px;font-size:${1.45*state.global.typeScale}rem'>${esc(b.content.title)}</h2><p class='ed' contenteditable='${state.mode==='draft'}' data-f='body' data-id='${b.id}'>${esc(b.content.body)}</p>`;
  if(b.type==='image') html=`<div style='text-align:${b.content.align}'><img src='${esc(b.content.src||'')}' style='width:${s.imgW||100}%;max-width:100%;border-radius:${s.radius||state.global.radius}px;object-fit:${s.fit||'cover'};min-height:120px;background:#1a2434'><div class='mini'>${esc(b.content.caption)}</div></div>`;
  if(b.type==='split') html=`<div style='display:grid;grid-template-columns:1fr 1fr;gap:14px'><div style='order:${b.content.swap?2:1}'><h3>${esc(b.content.title)}</h3><p>${esc(b.content.body)}</p></div><div style='order:${b.content.swap?1:2}'><img src='${esc(b.content.src||'')}' style='width:100%;min-height:140px;object-fit:${s.fit||'cover'};border-radius:${state.global.radius}px;background:#1a2434'></div></div>`;
  if(b.type==='gallery') html=`<div style='display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px'>${(b.content.items||[]).map(src=>`<img src='${esc(src)}' style='width:100%;aspect-ratio:1/1;object-fit:${s.fit||'cover'};border-radius:${state.global.radius}px;background:#1a2434'>`).join('')}</div>`;
  if(b.type==='footer'){
    const cols=b.content.cols.split('|').map(x=>`<div>${esc(x)}</div>`).join('');
    html=`<div style='display:grid;grid-template-columns:1.3fr 1fr 1fr;gap:10px'><div><strong>${esc(b.content.logo)}</strong><p>${esc(b.content.text)}</p></div><div>${cols}</div><div>${b.content.social.split(',').map(x=>`<span class='chip'>${esc(x.trim())}</span>`).join('')}</div></div>`;
  }
  const tools=state.mode==='draft'?`<div class='blk-tools'><button data-a='up' data-id='${b.id}' title='Move up'>↑</button><button data-a='down' data-id='${b.id}' title='Move down'>↓</button><button data-a='dup' data-id='${b.id}' title='Duplicate (⌘/Ctrl+D)'>⧉</button><button data-a='del' data-id='${b.id}' title='Delete block'>✕</button></div>`:'';
  return `<section class='blk ${state.selected===b.id?'sel':''}' data-id='${b.id}' style='${common}'>${tools}${html}</section>`;
}

function bindInline(){
  document.querySelectorAll('.blk').forEach(el=>el.onclick=(e)=>{if(e.target.closest('button[data-a]'))return; state.selected=el.dataset.id; render();});
  document.querySelectorAll('button[data-a]').forEach(btn=>btn.onclick=(e)=>{e.stopPropagation();const id=btn.dataset.id,a=btn.dataset.a,arr=state.blocks,i=arr.findIndex(b=>b.id===id);if(i<0)return;pushHist();
    if(a==='del')arr.splice(i,1); if(a==='dup')arr.splice(i+1,0,deep({...arr[i],id:uid()})); if(a==='up'&&i>0)[arr[i-1],arr[i]]=[arr[i],arr[i-1]]; if(a==='down'&&i<arr.length-1)[arr[i+1],arr[i]]=[arr[i],arr[i+1]]; state.selected=arr[Math.max(0,i)]?.id||null; render();queue();});
  document.querySelectorAll('.ed').forEach(ed=>ed.oninput=()=>{const b=state.blocks.find(x=>x.id===ed.dataset.id); if(!b)return;pushHist(); b.content[ed.dataset.f]=ed.textContent; queue();});
}

function syncInspector(){
  const b=state.blocks.find(x=>x.id===state.selected);
  const card=document.getElementById('blockCard');
  const apply=document.getElementById('applyAllDevices');
  apply.disabled=!b;
  if(!b){
    apply.checked=true;
    card.innerHTML='<h4 class="section-title">Selected block</h4><p class="mini">Pick a block to edit.</p>';
    return;
  }
  apply.checked=b.linkStyles;
  const s=styleFor(b);
  card.innerHTML=`<h4 class='section-title'>${b.type} block</h4>
    <div class='field'><label><input id='linkStyles' type='checkbox' ${b.linkStyles?'checked':''}> link styles across devices</label></div>
    <div class='row2'><div class='field'><label>Background</label><input id='bg' type='color' value='${toHex(s.bg||'#111722')}'></div><div class='field'><label>Text</label><input id='fg' type='color' value='${toHex(s.fg||'#edf1f8')}'></div>
      <div class='field'><label>Padding</label><input id='pad' type='number' min='0' max='120' value='${s.pad||22}'></div><div class='field'><label>Align</label><select id='align'><option ${sel((s.align||'left')==='left')}>left</option><option ${sel((s.align||'left')==='center')}>center</option><option ${sel((s.align||'left')==='right')}>right</option></select></div></div>
    <div class='row2'><div class='field'><label>Image fit</label><select id='fit'><option ${sel((s.fit||'cover')==='cover')}>cover</option><option ${sel((s.fit||'cover')==='contain')}>contain</option></select></div><div class='field'><label>Image width %</label><input id='imgW' type='number' min='20' max='100' value='${s.imgW||100}'></div></div>
    <div class='field'><label>Upload image</label><input id='imgUpload' type='file' accept='image/*'></div>
    ${blockFields(b)}
  `;
  ['bg','fg','pad','align','fit','imgW'].forEach(id=>{const el=document.getElementById(id); if(!el)return; el.oninput=()=>{pushHist();updateStyle(b,idMap(id),id==='pad'||id==='imgW'?Number(el.value):el.value); render();queue();};});
  document.getElementById('linkStyles').onchange=e=>{pushHist();b.linkStyles=e.target.checked;document.getElementById('applyAllDevices').checked=b.linkStyles;render();queue();};
  const up=document.getElementById('imgUpload'); if(up) up.onchange=e=>fileToData(e.target.files?.[0],src=>{pushHist();if(b.type==='gallery') b.content.items.push(src); else b.content.img=src,b.content.src=src; render();queue();});
  bindBlockInputs(b);
}
function idMap(id){return ({bg:'bg',fg:'fg',pad:'pad',align:'align',fit:'fit',imgW:'imgW'})[id]}
function sel(v){return v?'selected':''}
function toHex(c){if(!c)return'#111722';if(c.startsWith('#'))return c;const m=c.match(/\d+/g);return m?'#'+m.slice(0,3).map(n=>(+n).toString(16).padStart(2,'0')).join(''):'#111722'}
function blockFields(b){
  if(b.type==='header')return `<div class='field'><label>Logo</label><input data-k='logo' value='${esc(b.content.logo)}'></div><div class='field'><label>Title</label><input data-k='title' value='${esc(b.content.title)}'></div><div class='row2'><div class='field'><label>Logo position</label><select data-k='logoPos'><option ${sel(b.content.logoPos==='left')}>left</option><option ${sel(b.content.logoPos==='center')}>center</option><option ${sel(b.content.logoPos==='right')}>right</option></select></div><div class='field'><label>CTA</label><input data-k='cta' value='${esc(b.content.cta)}'></div></div><div class='field'><label>Nav links (comma)</label><input data-k='links' value='${esc(b.content.links)}'></div>`;
  if(b.type==='hero')return `<div class='field'><label>Preset</label><select data-k='preset'><option ${sel(b.content.preset==='split-right')}>split-right</option><option ${sel(b.content.preset==='split-left')}>split-left</option><option ${sel(b.content.preset==='background')}>background</option></select></div><div class='field'><label>Button text</label><input data-k='btn' value='${esc(b.content.btn)}'></div>`;
  if(b.type==='text')return `<div class='field'><label>Body</label><textarea data-k='body'>${esc(b.content.body)}</textarea></div>`;
  if(b.type==='image')return `<div class='field'><label>Caption</label><input data-k='caption' value='${esc(b.content.caption)}'></div><div class='field'><label>Align image</label><select data-k='align'><option ${sel(b.content.align==='left')}>left</option><option ${sel(b.content.align==='center')}>center</option><option ${sel(b.content.align==='right')}>right</option></select></div>`;
  if(b.type==='split')return `<div class='field'><label>Title</label><input data-k='title' value='${esc(b.content.title)}'></div><div class='field'><label>Body</label><textarea data-k='body'>${esc(b.content.body)}</textarea></div><div class='field'><label><input data-k='swap' type='checkbox' ${b.content.swap?'checked':''}> swap sides</label></div>`;
  if(b.type==='footer')return `<div class='field'><label>Footer text</label><input data-k='text' value='${esc(b.content.text)}'></div><div class='field'><label>Social links labels</label><input data-k='social' value='${esc(b.content.social)}'></div><div class='field'><label>Columns (|)</label><input data-k='cols' value='${esc(b.content.cols)}'></div>`;
  return '<p class="mini">Gallery: upload multiple images from device.</p>';
}
function bindBlockInputs(b){document.querySelectorAll('#blockCard [data-k]').forEach(el=>el.oninput=()=>{pushHist();const k=el.dataset.k; b.content[k]=el.type==='checkbox'?el.checked:el.value; render();queue();});}
function fileToData(f,cb){if(!f)return;const r=new FileReader();r.onload=()=>cb(r.result);r.readAsDataURL(f)}

// top controls
addBlock.onchange=e=>{if(!e.target.value)return;pushHist();state.blocks.push(mk(e.target.value));state.selected=state.blocks.at(-1).id;e.target.value='';render();queue();};
templatePick.onchange=e=>{const t=e.target.value;if(!t)return;pushHist();const m={saas:['header','hero','features','gallery','footer'],portfolio:['header','hero','image','split','gallery','footer'],landing:['hero','text','split','footer']};state.blocks=(m[t]||['hero']).map(x=>x==='features'?mk('text'):mk(x));state.selected=state.blocks[0].id;e.target.value='';render();queue();};
save.onclick=()=>persist(false);
undo.onclick=()=>{if(!history.length)return;future.push(JSON.stringify(state));state=JSON.parse(history.pop());render();persist(true)};
redo.onclick=()=>{if(!future.length)return;history.push(JSON.stringify(state));state=JSON.parse(future.pop());render();persist(true)};
modeBtn.onclick=()=>{state.mode=state.mode==='draft'?'published':'draft';modeBtn.textContent='Mode: '+(state.mode==='draft'?'Draft':'Published');render();};
publishBtn.onclick=()=>{state.published=deep({blocks:state.blocks,seo:state.seo,global:state.global,at:new Date().toISOString()});state.mode='published';modeBtn.textContent='Mode: Published';persist(false);render();};
function exported(){const html=blocksToHTML(state.blocks,state);const css=`body{font-family:Inter,system-ui,sans-serif;background:#0b0d12;color:#edf1f8} .wrap{max-width:${state.global.maxWidth}px;margin:0 auto}`;return `<!doctype html><html><head><meta charset='utf-8'><title>${esc(state.seo.title)}</title><meta name='description' content='${esc(state.seo.description)}'><meta property='og:image' content='${esc(state.seo.og)}'><style>${css}</style></head><body><main class='wrap'>${html}</main></body></html>`;}
function blocksToHTML(arr){return arr.map(b=>`<section style="padding:${(b.style.global.pad||20)*state.global.spacing}px;background:${b.style.global.bg};color:${b.style.global.fg};margin:10px;border-radius:${state.global.radius}px">${b.type.toUpperCase()}</section>`).join('')}
exportBtn.onclick=()=>{const blob=new Blob([exported()],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='msj-export.html';a.click();URL.revokeObjectURL(a.href)};
copyBtn.onclick=async()=>{await navigator.clipboard.writeText(exported());status('Export copied', 'ok')};
['seoTitle','seoDesc','seoOg','gType','gSpace','gMax','gRadius','gShadow'].forEach(id=>window[id].oninput=()=>{pushHist();state.seo.title=seoTitle.value;state.seo.description=seoDesc.value;state.seo.og=seoOg.value;state.global.typeScale=+gType.value||1;state.global.spacing=+gSpace.value||1;state.global.maxWidth=+gMax.value||1120;state.global.radius=+gRadius.value||14;state.global.shadow=gShadow.checked;render();queue();});
document.querySelectorAll('.device-switch button').forEach(b=>b.onclick=()=>switchDevice(b.dataset.d));

document.getElementById('applyAllDevices').onchange=e=>{const b=state.blocks.find(x=>x.id===state.selected);if(!b)return;pushHist();b.linkStyles=e.target.checked;render();queue();};

document.addEventListener('keydown',e=>{
  const mod=e.metaKey||e.ctrlKey;
  if(mod&&e.key.toLowerCase()==='s'){e.preventDefault();persist(false);}
  if(mod&&e.key.toLowerCase()==='d'){e.preventDefault();duplicateSelected();}
});

function duplicateSelected(){
  const id=state.selected; if(!id) return;
  const arr=state.blocks; const i=arr.findIndex(b=>b.id===id); if(i<0) return;
  pushHist(); arr.splice(i+1,0,deep({...arr[i],id:uid()})); state.selected=arr[i+1].id; render(); queue(); status('Block duplicated', 'ok');
}

function switchDevice(next){
  if(!next||next===state.device)return;
  const frame=document.getElementById('previewFrame');
  frame.classList.add('switching');
  state.device=next;
  render();
  setTimeout(()=>frame.classList.remove('switching'),170);
}

function syncDeviceButtons(){
  document.querySelectorAll('.device-switch button').forEach(btn=>btn.classList.toggle('active',btn.dataset.d===state.device));
}

function syncTop(){seoTitle.value=state.seo.title;seoDesc.value=state.seo.description;seoOg.value=state.seo.og;gType.value=state.global.typeScale;gSpace.value=state.global.spacing;gMax.value=state.global.maxWidth;gRadius.value=state.global.radius;gShadow.checked=state.global.shadow;modeBtn.textContent='Mode: '+(state.mode==='draft'?'Draft':'Published')}
syncTop(); render();
</script>
</body>
</html>