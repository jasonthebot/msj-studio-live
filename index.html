<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>msj-studio ‚Ä¢ Editorial Builder</title>
  <style>
    :root{
      --bg:#f4f1ea;
      --shell:#f8f6f1;
      --panel:#fffdf8;
      --panel-soft:#f2eee6;
      --line:#e4ddd0;
      --line-strong:#d7cfbf;
      --text:#1f1d19;
      --muted:#6f695f;
      --accent:#2f5cff;
      --accent-soft:#e7edff;
      --ok:#2c7a51;
      --shadow:0 8px 30px rgba(29,20,10,.08);
    }

    body.dark{
      --bg:#14161c;
      --shell:#111318;
      --panel:#1a1d25;
      --panel-soft:#1f2430;
      --line:#2e3442;
      --line-strong:#3b4355;
      --text:#eceff7;
      --muted:#a7aec0;
      --accent:#7da2ff;
      --accent-soft:#223055;
      --ok:#65d89a;
      --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,sans-serif;background:radial-gradient(circle at 10% -20%,#fff,#f2ede3 52%,#ede8de);color:var(--text);overflow:hidden}
    button,input,select,textarea{font:inherit;color:var(--text)}
    button{cursor:pointer;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;transition:.18s ease}
    button:hover{border-color:var(--line-strong);box-shadow:0 3px 10px rgba(40,25,5,.08)}
    input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff}
    textarea{resize:vertical}

    .app{height:100vh;display:grid;grid-template-columns:92px 1fr 390px;grid-template-rows:72px 1fr;background:var(--shell)}

    .rail{grid-row:1/3;background:linear-gradient(180deg,#fcfaf6,#f4efe6);border-right:1px solid var(--line);padding:12px 10px;display:flex;flex-direction:column;gap:16px}
    .logo{height:44px;display:grid;place-items:center;font-weight:700;letter-spacing:.11em;border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:var(--shadow)}
    .rail-nav{display:flex;flex-direction:column;gap:8px}
    .rail-btn{border:1px solid transparent;background:transparent;display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px 6px;font-size:.73rem;color:var(--muted)}
    .rail-btn.active{background:var(--accent-soft);color:#233468;border-color:#d2ddff}

    .topbar{grid-column:2/4;height:72px;padding:12px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px;background:rgba(252,249,243,.9);backdrop-filter:blur(6px)}
    .context{padding:9px 12px;background:#fff;border:1px solid var(--line);border-radius:12px;font-size:.86rem;color:#4f4a41;min-width:230px}
    .seg{display:flex;gap:6px;padding-right:10px;border-right:1px solid var(--line)}
    .seg:last-child{border-right:0}
    .seg button.active{background:#111;color:#fff;border-color:#111}
    .grow{margin-left:auto}
    .primary{background:#111;color:#fff;border-color:#111}
    .ghost{background:#fffdf8}
    #status{font-size:.79rem;color:var(--muted);min-width:120px;text-align:right}
    #status.ok{color:var(--ok)}

    .stage{grid-column:2;grid-row:2;display:grid;grid-template-rows:auto 1fr;background:#f6f3ed}
    .create-strip{padding:10px 14px;border-bottom:1px solid var(--line);display:flex;gap:8px;flex-wrap:wrap;background:#fbf8f2}
    .create-strip select{min-width:170px}

    .canvas-zone{overflow:auto;padding:24px}
    .canvas-center{display:flex;justify-content:center;min-height:100%}
    .preview-frame{width:min(100%,1260px);transition:.2s ease;transform-origin:top center}
    .preview-frame[data-device="tablet"]{width:min(100%,900px)}
    .preview-frame[data-device="mobile"]{width:min(100%,460px)}
    .site{background:#f9f6f0;border:1px dashed #dfd6c6;border-radius:18px;padding:18px}

    .section{position:relative;border:1px solid #dfd6c9;margin:12px 0;border-radius:16px;transition:.16s ease;overflow:hidden}
    .section:hover{border-color:#c9bfaf}
    .section.sel{border-color:var(--accent);box-shadow:0 0 0 2px #dbe3ff}
    .section.sel::before{content:'Selected';position:absolute;left:14px;top:8px;font-size:.67rem;background:#1f48db;color:#fff;border-radius:999px;padding:2px 8px;z-index:4}
    .section-tools{position:absolute;right:10px;top:10px;display:flex;gap:4px;background:rgba(255,255,255,.93);border:1px solid #ded3c4;padding:4px;border-radius:10px;z-index:5}
    .section-tools button{padding:3px 7px;font-size:.74rem}
    .editable{outline:none}
    .editable:focus{box-shadow:0 0 0 2px #dfe7ff;border-radius:6px}
    .draggable{position:relative;display:inline-block}
    .draggable.drag-on{cursor:grab;user-select:none;touch-action:none}
    .draggable.dragging{cursor:grabbing;opacity:.9}
    .draggable.selected-item{outline:1px dashed var(--accent);outline-offset:2px}
    .resize-handle{position:absolute;right:-6px;bottom:-6px;width:14px;height:14px;border-radius:3px;background:var(--accent);border:2px solid #fff;cursor:nwse-resize;z-index:8;box-shadow:0 2px 8px rgba(0,0,0,.2)}
    .section-resize-handle{position:absolute;right:6px;bottom:6px;width:16px;height:16px;border-radius:4px;background:var(--accent);border:2px solid #fff;cursor:nwse-resize;z-index:9}

    .inspector{grid-column:3;grid-row:2;border-left:1px solid var(--line);background:#f9f6f0;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:12px}
    .inspector h3{margin:2px 0 0;font-size:.79rem;text-transform:uppercase;letter-spacing:.14em;color:#4a453d}
    .panel{border:1px solid var(--line);background:var(--panel);border-radius:14px;padding:12px;box-shadow:0 4px 18px rgba(24,16,3,.04)}
    .panel h4{margin:0 0 10px;font-size:.74rem;text-transform:uppercase;letter-spacing:.11em;color:#5b544a}
    .field{margin-bottom:10px}
    .field:last-child{margin-bottom:0}
    .field label{display:block;font-size:.78rem;color:var(--muted);margin-bottom:5px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .mini{font-size:.78rem;color:var(--muted);line-height:1.45}
    .chip{display:inline-flex;padding:4px 10px;border:1px solid #ddd2c2;border-radius:999px;background:#fff9ef;font-size:.75rem;margin:2px 4px 2px 0}
    .token-preset{display:grid;grid-template-columns:1fr 1fr;gap:8px}


    .theme-toggle{position:fixed;right:14px;bottom:14px;z-index:40;border:1px solid var(--line-strong);background:var(--panel);border-radius:999px;padding:8px 11px;font-size:.88rem;box-shadow:var(--shadow)}

    body.dark{background:radial-gradient(circle at 10% -20%,#1d2230,#121722 54%,#0f141d)}
    body.dark button{background:#1a1e27;color:var(--text)}
    body.dark input, body.dark select, body.dark textarea{background:#161a22;color:var(--text)}
    body.dark .rail{background:linear-gradient(180deg,#151922,#121620)}
    body.dark .logo{background:#171b24}
    body.dark .topbar{background:rgba(17,19,24,.92)}
    body.dark .context{background:#181c24;color:#cfd6e7}
    body.dark .stage{background:#121620}
    body.dark .create-strip{background:#151a22}
    body.dark .site{background:#151922;border-color:#2f3748}
    body.dark .section{border-color:#2d3545;background:#151a23}
    body.dark .section-tools{background:rgba(24,27,35,.95);border-color:#374155}
    body.dark .inspector{background:#141924}
    body.dark .chip{background:#1b2230;border-color:#36405a}

    @media (max-width:1320px){
      .app{grid-template-columns:76px 1fr}
      .topbar{grid-column:2}
      .inspector{position:fixed;right:0;top:72px;bottom:0;width:360px;z-index:20}
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="rail">
    <div class="logo">MSJ</div>
    <nav class="rail-nav">
      <button class="rail-btn active" data-panel="create">Ôºã<span>Create</span></button>
      <button class="rail-btn" data-panel="content">‚ñ¶<span>Sections</span></button>
      <button class="rail-btn" data-panel="theme">‚óê<span>Tokens</span></button>
      <button class="rail-btn" data-panel="settings">‚öô<span>Project</span></button>
    </nav>
  </aside>

  <header class="topbar">
    <div class="context">Page: Home / Editorial Template</div>
    <div class="seg" id="deviceSwitch">
      <button data-d="desktop">Desktop</button>
      <button data-d="tablet">Tablet</button>
      <button data-d="mobile">Mobile</button>
    </div>
    <div class="seg">
      <button id="zoomOut">‚àí</button><button id="zoomIn">Ôºã</button>
      <div class="mini" id="zoomLabel" style="align-self:center;margin-left:6px">100%</div>
    </div>
    <div class="seg">
      <button id="undo">Undo</button><button id="redo">Redo</button>
    </div>
    <div class="seg">
      <button id="toolModeBtn">Tool: Edit</button>
      <button id="snapBtn">Snap: On</button>
    </div>
    <div class="seg grow">
      <button id="copyBtn" class="ghost">Copy export</button>
      <button id="exportBtn" class="ghost">Export</button>
    </div>
    <button id="save" class="primary">Save</button>
    <button id="publishBtn">Publish</button>
    <button id="modeBtn">Mode: Draft</button>
    <div id="status">Ready</div>
  </header>

  <main class="stage">
    <div class="create-strip" id="createStrip">
      <select id="addSection">
        <option value="">+ Add section</option>
        <option value="header">Header</option>
        <option value="hero">Hero</option>
        <option value="feature">Feature grid</option>
        <option value="story">Story / Editorial</option>
        <option value="split">Split media</option>
        <option value="quote">Quote</option>
        <option value="gallery">Gallery</option>
        <option value="cta">CTA</option>
        <option value="footer">Footer</option>
      </select>
      <select id="layoutPreset">
        <option value="">Page presets</option>
        <option value="campaign">Campaign</option>
        <option value="journal">Journal</option>
        <option value="studio">Studio profile</option>
      </select>
      <button id="saveReusable">Save selected as reusable</button>
      <select id="insertReusable"><option value="">Insert reusable</option></select>
    </div>

    <div class="canvas-zone">
      <div class="canvas-center">
        <div class="preview-frame" id="previewFrame" data-device="desktop">
          <div class="site" id="site"></div>
        </div>
      </div>
    </div>
  </main>

  <aside class="inspector">
    <h3>Inspector</h3>

    <section class="panel" id="scopePanel">
      <h4>Responsive scope</h4>
      <div class="field"><label><input id="linkResponsive" type="checkbox" checked> Link spacing across devices</label></div>
      <div class="mini">Turn off to define tablet/mobile spacing independently. Typography can also be linked/unlinked below.</div>
    </section>

    <section class="panel" id="settingsPanel">
      <h4>Project settings</h4>
      <div class="field"><label>SEO title</label><input id="seoTitle"></div>
      <div class="field"><label>Meta description</label><textarea id="seoDesc" rows="2"></textarea></div>
      <div class="field"><label>OG image URL</label><input id="seoOg"></div>
    </section>

    <section class="panel" id="tokenPanel">
      <h4>Global design tokens</h4>
      <div class="token-preset">
        <button data-token-preset="linen">Linen</button>
        <button data-token-preset="stone">Stone</button>
        <button data-token-preset="ink">Ink serif</button>
        <button data-token-preset="contrast">Contrast</button>
      </div>
      <div class="row2" style="margin-top:10px">
        <div class="field"><label>Page background</label><input id="tkBg" type="color"></div>
        <div class="field"><label>Panel background</label><input id="tkPanel" type="color"></div>
        <div class="field"><label>Text</label><input id="tkText" type="color"></div>
        <div class="field"><label>Accent</label><input id="tkAccent" type="color"></div>
      </div>
      <div class="row2">
        <div class="field"><label>Type scale</label><input id="tkType" type="number" min="0.7" max="1.8" step="0.05"></div>
        <div class="field"><label>Spacing scale</label><input id="tkSpace" type="number" min="0.7" max="2" step="0.05"></div>
        <div class="field"><label>Max width</label><input id="tkMax" type="number" min="760" max="1440"></div>
        <div class="field"><label>Radius</label><input id="tkRadius" type="number" min="0" max="38"></div>
      </div>
      <div class="field"><label><input id="tkShadow" type="checkbox"> Soft shadows</label></div>
    </section>

    <section class="panel" id="sectionCard"><h4>Selected section</h4><p class="mini">Select a section to edit variants, layout, typography, spacing, background, media and CTA controls.</p></section>
    <section class="panel"><div class="mini">Shortcuts: <strong>‚åò/Ctrl + S</strong> save, <strong>‚åò/Ctrl + D</strong> duplicate section.</div></section>
  </aside>
</div>
<button id="themeToggle" class="theme-toggle" title="Toggle day/night">üåô Night</button>

<script>
const STORE='msj_editorial_v3';
const REUSABLE='msj_editorial_reusable_v1';
const deep=o=>JSON.parse(JSON.stringify(o));
const uid=()=>crypto.randomUUID();

const PRESET_TOKENS={
  linen:{bg:'#f4f1ea',panel:'#fffdf8',text:'#1f1d19',accent:'#2f5cff',typeScale:1,spacing:1,maxWidth:1160,radius:16,shadow:true},
  stone:{bg:'#efede9',panel:'#f8f7f4',text:'#23211d',accent:'#355a46',typeScale:1.02,spacing:1.05,maxWidth:1120,radius:12,shadow:false},
  ink:{bg:'#f8f4ee',panel:'#fff',text:'#191816',accent:'#5939d9',typeScale:1.08,spacing:1,maxWidth:1080,radius:14,shadow:true},
  contrast:{bg:'#f5f5f5',panel:'#fff',text:'#111',accent:'#0b57ff',typeScale:1,spacing:.95,maxWidth:1200,radius:10,shadow:true}
};

const DEVICE_ORDER=['desktop','tablet','mobile'];

function mk(type){
  const base={
    id:uid(),type,variant:'default',
    responsive:{linkSpace:true,linkType:true,space:{desktop:44,tablet:34,mobile:24},font:{desktop:1,tablet:.96,mobile:.92}},
    style:{bg:'#fffdf8',fg:'#1f1d19',align:'left',radius:16,overlay:0,fit:'cover',imgW:100,eyebrow:true,ctaStyle:'solid'},
    layout:{box:{w:null,h:null},items:{},media:{w:null,h:null}},
    content:{}
  };
  if(type==='header') return {...base,variant:'minimal',content:{brand:'MSJ Studio',links:'Work,About,Journal,Contact',cta:'Start project'}};
  if(type==='hero') return {...base,variant:'split-right',content:{eyebrow:'Independent design studio',headline:'Craft clear brand narratives with editorial rhythm.',sub:'Build clean storytelling pages with modular sections, reusable blocks, and responsive controls.',cta:'Explore sections',cta2:'Book intro',img:''}};
  if(type==='feature') return {...base,variant:'cards-3',content:{title:'Capabilities',items:'Identity systems|Visual direction|Web narratives|Launch kits'}};
  if(type==='story') return {...base,variant:'longform',content:{title:'Story block',body:'Use this section for richer editorial storytelling. Pair paragraphs with calm spacing and elegant typography for a premium, modern feel.'}};
  if(type==='split') return {...base,variant:'image-right',content:{title:'Flexible split layout',body:'Mix text and media with side swaps and width control.',img:'',swap:false}};
  if(type==='quote') return {...base,variant:'center',content:{quote:'‚ÄúA clean system should feel effortless to edit.‚Äù',author:'‚Äî Studio principle'}};
  if(type==='gallery') return {...base,variant:'three-up',content:{items:[]}};
  if(type==='cta') return {...base,variant:'center',content:{title:'Ready to build?',sub:'Compose pages quickly with reusable sections.',cta:'Get started'}};
  if(type==='footer') return {...base,variant:'columns',content:{brand:'MSJ Studio',text:'¬© 2026 MSJ. Built local-first.',links:'Privacy|Terms|Contact',social:'X,Instagram,LinkedIn'}};
}

function initial(){
  return {
    mode:'draft',device:'desktop',zoom:1,selected:null,published:null,railPanel:'create',toolMode:'edit',snapToGrid:true,gridSize:8,
    seo:{title:'msj-studio editorial site',description:'Built in msj-studio',og:''},
    tokens:deep(PRESET_TOKENS.linen),
    sections:[mk('header'),mk('hero'),mk('feature'),mk('story'),mk('cta'),mk('footer')]
  };
}

let state=load()||initial();
state.toolMode=state.toolMode||'edit';
if(state.snapToGrid===undefined) state.snapToGrid=true;
if(!state.gridSize) state.gridSize=8;
(state.sections||[]).forEach(s=>{if(!s.layout)s.layout={box:{w:null,h:null},items:{},media:{w:null,h:null}}});
let history=[],future=[],autosave;

function load(){try{return JSON.parse(localStorage.getItem(STORE))}catch{return null}}
function saveSilent(msg='Autosaved'){localStorage.setItem(STORE,JSON.stringify(state));status(msg,'ok')}
function pushHist(){history.push(JSON.stringify(state));if(history.length>120)history.shift();future=[]}
function queue(){clearTimeout(autosave);status('Editing‚Ä¶');autosave=setTimeout(()=>saveSilent('Autosaved'),420)}
function status(text,cls=''){const el=document.getElementById('status');el.textContent=text;el.className=cls}
function esc(s=''){return String(s).replace(/[&<>\"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]))}
function hex(c){if(!c) return '#ffffff';if(c.startsWith('#'))return c;const m=c.match(/\d+/g);return m?'#'+m.slice(0,3).map(n=>(+n).toString(16).padStart(2,'0')).join(''):'#ffffff'}

function activeSections(){return state.mode==='draft'?state.sections:(state.published?.sections||state.sections)}
function sectionById(id){return state.sections.find(s=>s.id===id)}

function applyTokensToUI(){
  const t=state.tokens;
  document.documentElement.style.setProperty('--bg',t.bg);
  document.documentElement.style.setProperty('--panel',t.panel);
  document.documentElement.style.setProperty('--text',t.text);
  document.documentElement.style.setProperty('--accent',t.accent);
  document.documentElement.style.setProperty('--accent-soft',t.accent+'22');
}


function updateRailPanel(){
  const p=state.railPanel||'create';
  const show=(id,on,display='block')=>{const el=document.getElementById(id); if(!el) return; el.style.display=on?display:'none';};
  show('createStrip', p==='create', 'flex');
  show('scopePanel', p==='create' || p==='content');
  show('sectionCard', p==='create' || p==='content');
  show('tokenPanel', p==='theme');
  show('settingsPanel', p==='settings');
}

function spaceFor(s){return (s.responsive.linkSpace? s.responsive.space.desktop : s.responsive.space[state.device]) || s.responsive.space.desktop || 40}
function fontFor(s){return (s.responsive.linkType? s.responsive.font.desktop : s.responsive.font[state.device]) || s.responsive.font.desktop || 1}
function clamp(n,min,max){return Math.max(min,Math.min(max,n))}
function snap(n){return state.snapToGrid?Math.round(n/state.gridSize)*state.gridSize:n}
function itemLayout(s,key){if(!s.layout)s.layout={box:{w:null,h:null},items:{},media:{w:null,h:null}};if(!s.layout.items[key])s.layout.items[key]={x:0,y:0,w:null,h:null};return s.layout.items[key]}
function dragWrap(s,key,html,opts={}){
  const l=itemLayout(s,key);
  const tx=Number(l.x)||0,ty=Number(l.y)||0;
  const w=l.w||opts.w||null,h=l.h||opts.h||null;
  const extra=`transform:translate(${tx}px,${ty}px);${w?`width:${w}px;`:''}${h?`height:${h}px;`:''}${opts.block?'display:block;':''}`;
  const canDrag=state.mode==='draft'&&state.toolMode==='move';
  const cls=`draggable ${canDrag?'drag-on':''}`;
  const resize=(canDrag&&opts.resizable)?`<span class='resize-handle' data-resize='item' data-id='${s.id}' data-key='${key}'></span>`:'';
  return `<div class='${cls}' data-draggable='item' data-id='${s.id}' data-key='${key}' style='${extra}'>${html}${resize}</div>`;
}

function render(){
  applyTokensToUI();
  const frame=previewFrame;
  frame.dataset.device=state.device;
  frame.style.transform=`scale(${state.zoom})`;
  zoomLabel.textContent=Math.round(state.zoom*100)+'%';

  site.style.maxWidth=state.tokens.maxWidth+'px';
  site.style.margin='0 auto';

  const list=activeSections();
  site.innerHTML=list.map(renderSection).join('');
  bindCanvasEvents();
  syncTop();
  syncInspector();
  syncDeviceButtons();
  loadReusableChoices();
}

function sectionShell(s,inner){
  const pad=spaceFor(s)*state.tokens.spacing;
  const fs=fontFor(s)*state.tokens.typeScale;
  const shadow=state.tokens.shadow?'box-shadow:0 14px 36px rgba(28,19,6,.08);':'';
  const bw=s.layout?.box?.w?`width:${s.layout.box.w}px;max-width:100%;`:'';
  const bh=s.layout?.box?.h?`min-height:${s.layout.box.h}px;`:'';
  const style=`background:${s.style.bg};color:${s.style.fg};padding:${pad}px;border-radius:${s.style.radius||state.tokens.radius}px;text-align:${s.style.align};font-size:${fs}rem;${shadow}${bw}${bh}`;
  const tools=state.mode==='draft'?`<div class='section-tools'><button data-act='up' data-id='${s.id}'>‚Üë</button><button data-act='down' data-id='${s.id}'>‚Üì</button><button data-act='dup' data-id='${s.id}'>‚ßâ</button><button data-act='del' data-id='${s.id}'>‚úï</button></div>`:'';
  const canResize=state.mode==='draft'&&state.toolMode==='move'&&state.selected===s.id;
  const resize=canResize?`<span class='section-resize-handle' data-resize='section' data-id='${s.id}'></span>`:'';
  return `<section class='section ${state.selected===s.id?'sel':''}' data-id='${s.id}' style='${style}'>${tools}${inner}${resize}</section>`;
}

function renderSection(s){
  const c=s.content;
  if(s.type==='header'){
    const links=(c.links||'').split(',').map(v=>`<span class='chip'>${esc(v.trim())}</span>`).join('');
    const html=`<div style='display:flex;gap:12px;justify-content:space-between;align-items:center;flex-wrap:wrap'>${dragWrap(s,'brand',`<strong>${esc(c.brand)}</strong>`)}${dragWrap(s,'chips',`<div>${links}</div>`)}${dragWrap(s,'cta',`<button>${esc(c.cta)}</button>`)}</div>`;
    return sectionShell(s,html);
  }
  if(s.type==='hero'){
    const canEdit=state.mode==='draft'&&state.toolMode==='edit';
    const eyebrow=s.style.eyebrow?dragWrap(s,'eyebrow',`<div class='mini'>${esc(c.eyebrow||'')}</div>`):'';
    const head=dragWrap(s,'headline',`<h1 class='editable' contenteditable='${canEdit}' data-id='${s.id}' data-field='headline' style='margin:.3rem 0 .5rem;font-size:${2.3*state.tokens.typeScale}rem;line-height:1.08'>${esc(c.headline)}</h1>`,{block:true});
    const sub=dragWrap(s,'sub',`<p class='editable' contenteditable='${canEdit}' data-id='${s.id}' data-field='sub'>${esc(c.sub)}</p>`,{block:true});
    const ctas=dragWrap(s,'ctas',`<div style='display:flex;gap:8px;flex-wrap:wrap'><button>${esc(c.cta)}</button><button style='background:transparent'>${esc(c.cta2)}</button></div>`);
    const text=`${eyebrow}${head}${sub}${ctas}`;
    const mW=s.layout?.media?.w?`width:${s.layout.media.w}px;max-width:100%;`:`width:${s.style.imgW}%;max-width:100%;`;
    const mH=s.layout?.media?.h?`height:${s.layout.media.h}px;`:'min-height:220px;';
    const imgInner=c.img?`<img src='${esc(c.img)}' style='${mW}${mH}border-radius:${state.tokens.radius}px;object-fit:${s.style.fit};background:#efe7db'>`:'';
    const img=dragWrap(s,'media',imgInner,{resizable:!!c.img});
    let html='';
    if(s.variant==='background' && c.img){ html=`<div style='background:linear-gradient(rgba(255,255,255,.65),rgba(255,255,255,.65)), url(${esc(c.img)}) center/cover; padding:42px;border-radius:${state.tokens.radius}px'>${text}</div>`; }
    else html=`<div style='display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:center'>${s.variant==='split-left'?img+text:text+img}</div>`;
    return sectionShell(s,html);
  }
  if(s.type==='feature'){
    const items=(c.items||'').split('|').map(v=>`<div style='padding:12px;border:1px solid #e8dece;border-radius:${state.tokens.radius-2}px;background:#fff'>${esc(v.trim())}</div>`).join('');
    const cols=s.variant==='cards-2'?2:(s.variant==='cards-4'?4:3);
    return sectionShell(s,`${dragWrap(s,'title',`<h2>${esc(c.title)}</h2>`,{block:true})}<div style='display:grid;grid-template-columns:repeat(${cols},minmax(0,1fr));gap:10px'>${dragWrap(s,'items',items,{block:true})}</div>`);
  }
  if(s.type==='story') {
    const canEdit=state.mode==='draft'&&state.toolMode==='edit';
    return sectionShell(s,`${dragWrap(s,'title',`<h2 class='editable' contenteditable='${canEdit}' data-id='${s.id}' data-field='title'>${esc(c.title)}</h2>`,{block:true})}${dragWrap(s,'body',`<p class='editable' contenteditable='${canEdit}' data-id='${s.id}' data-field='body' style='max-width:70ch;line-height:1.7'>${esc(c.body)}</p>`,{block:true})}`);
  }
  if(s.type==='split'){
    const mW=s.layout?.media?.w?`width:${s.layout.media.w}px;max-width:100%;`:`width:${s.style.imgW}%;max-width:100%;`;
    const mH=s.layout?.media?.h?`height:${s.layout.media.h}px;`:'min-height:190px;';
    const mediaInner=c.img?`<img src='${esc(c.img)}' style='${mW}${mH}border-radius:${state.tokens.radius}px;object-fit:${s.style.fit};background:#eee'>`:"<div style='height:200px;background:#efe8dc;border-radius:12px'></div>";
    const media=dragWrap(s,'media',mediaInner,{resizable:!!c.img});
    const text=dragWrap(s,'text',`<div><h3>${esc(c.title)}</h3><p>${esc(c.body)}</p></div>`,{block:true});
    return sectionShell(s,`<div style='display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:center'>${c.swap?media+text:text+media}</div>`);
  }
  if(s.type==='quote') return sectionShell(s,`${dragWrap(s,'quote',`<blockquote style='font-size:${1.5*state.tokens.typeScale}rem;margin:0 0 8px;line-height:1.4'>${esc(c.quote)}</blockquote>`,{block:true})}${dragWrap(s,'author',`<div class='mini'>${esc(c.author)}</div>`)}`);
  if(s.type==='gallery'){
    const cols=s.variant==='two-up'?2:(s.variant==='four-up'?4:3);
    const tiles=(c.items||[]).map(src=>`<img src='${esc(src)}' style='width:100%;aspect-ratio:1/1;object-fit:${s.style.fit};border-radius:${state.tokens.radius-3}px;background:#eee'>`).join('');
    return sectionShell(s,`<div style='display:grid;grid-template-columns:repeat(${cols},minmax(0,1fr));gap:10px'>${tiles||"<div class='mini'>Upload images from inspector.</div>"}</div>`);
  }
  if(s.type==='cta') return sectionShell(s,`${dragWrap(s,'title',`<h2>${esc(c.title)}</h2>`,{block:true})}${dragWrap(s,'sub',`<p>${esc(c.sub)}</p>`,{block:true})}${dragWrap(s,'button',`<button>${esc(c.cta)}</button>`)}`);
  if(s.type==='footer'){
    const links=(c.links||'').split('|').map(v=>`<div>${esc(v.trim())}</div>`).join('');
    const social=(c.social||'').split(',').map(v=>`<span class='chip'>${esc(v.trim())}</span>`).join('');
    return sectionShell(s,`<div style='display:grid;grid-template-columns:1.2fr 1fr 1fr;gap:12px'><div>${dragWrap(s,'brand',`<strong>${esc(c.brand)}</strong>`)}${dragWrap(s,'text',`<p>${esc(c.text)}</p>`)}</div><div>${dragWrap(s,'links',links,{block:true})}</div><div>${dragWrap(s,'social',social,{block:true})}</div></div>`);
  }
  return sectionShell(s,'');
}

function bindCanvasEvents(){
  document.querySelectorAll('.section').forEach(el=>el.onclick=e=>{
    if(e.target.closest('button[data-act],.resize-handle,.section-resize-handle'))return;
    state.selected=el.dataset.id;
    render();
  });
  document.querySelectorAll('button[data-act]').forEach(btn=>btn.onclick=e=>{
    e.stopPropagation();
    const id=btn.dataset.id,act=btn.dataset.act;
    const arr=state.sections;const i=arr.findIndex(x=>x.id===id);if(i<0)return;
    pushHist();
    if(act==='del')arr.splice(i,1);
    if(act==='dup')arr.splice(i+1,0,deep({...arr[i],id:uid()}));
    if(act==='up'&&i>0)[arr[i-1],arr[i]]=[arr[i],arr[i-1]];
    if(act==='down'&&i<arr.length-1)[arr[i+1],arr[i]]=[arr[i],arr[i+1]];
    state.selected=arr[Math.max(0,i)]?.id||null;
    render();queue();
  });
  document.querySelectorAll('.editable').forEach(ed=>ed.oninput=()=>{
    const sec=sectionById(ed.dataset.id); if(!sec)return;
    pushHist(); sec.content[ed.dataset.field]=ed.textContent; queue();
  });

  if(!(state.mode==='draft'&&state.toolMode==='move')) return;

  document.querySelectorAll('[data-draggable="item"]').forEach(el=>el.onpointerdown=e=>{
    if(e.target.closest('.resize-handle')) return;
    e.preventDefault();
    const sec=sectionById(el.dataset.id); if(!sec)return;
    const key=el.dataset.key; const l=itemLayout(sec,key);
    const secEl=el.closest('.section'); if(!secEl) return;
    const startX=e.clientX,startY=e.clientY;
    const sx=l.x||0, sy=l.y||0;
    el.classList.add('dragging');
    const onMove=ev=>{
      const nextX=snap(sx + (ev.clientX-startX));
      const nextY=snap(sy + (ev.clientY-startY));
      const secRect=secEl.getBoundingClientRect();
      const itemRect=el.getBoundingClientRect();
      const minX=-(itemRect.left-secRect.left)+sx;
      const maxX=(secRect.right-itemRect.right)+sx;
      const minY=-(itemRect.top-secRect.top)+sy;
      const maxY=(secRect.bottom-itemRect.bottom)+sy;
      l.x=clamp(nextX,minX,maxX);
      l.y=clamp(nextY,minY,maxY);
      el.style.transform=`translate(${l.x}px,${l.y}px)`;
    };
    const onUp=()=>{el.classList.remove('dragging');window.removeEventListener('pointermove',onMove);window.removeEventListener('pointerup',onUp);queue();saveSilent('Layout updated');};
    pushHist();
    window.addEventListener('pointermove',onMove);
    window.addEventListener('pointerup',onUp);
  });

  document.querySelectorAll('.section-resize-handle').forEach(h=>h.onpointerdown=e=>{
    e.preventDefault();e.stopPropagation();
    const sec=sectionById(h.dataset.id); if(!sec)return;
    const secEl=h.closest('.section'); if(!secEl)return;
    const startW=secEl.offsetWidth,startH=secEl.offsetHeight,startX=e.clientX,startY=e.clientY;
    pushHist();
    const onMove=ev=>{
      sec.layout.box.w=Math.max(260, snap(startW + (ev.clientX-startX)));
      sec.layout.box.h=Math.max(120, snap(startH + (ev.clientY-startY)));
      secEl.style.width=sec.layout.box.w+'px';
      secEl.style.minHeight=sec.layout.box.h+'px';
    };
    const onUp=()=>{window.removeEventListener('pointermove',onMove);window.removeEventListener('pointerup',onUp);render();queue();};
    window.addEventListener('pointermove',onMove);
    window.addEventListener('pointerup',onUp);
  });

  document.querySelectorAll('.resize-handle').forEach(h=>h.onpointerdown=e=>{
    e.preventDefault();e.stopPropagation();
    const sec=sectionById(h.dataset.id); if(!sec)return;
    const key=h.dataset.key;const l=itemLayout(sec,key);
    const host=h.parentElement; if(!host)return;
    const rect=host.getBoundingClientRect();
    const startW=rect.width,startH=rect.height,startX=e.clientX,startY=e.clientY;
    pushHist();
    const onMove=ev=>{
      l.w=Math.max(80,snap(startW + (ev.clientX-startX)));
      l.h=Math.max(60,snap(startH + (ev.clientY-startY)));
      if(key==='media'&&sec.layout) sec.layout.media={w:l.w,h:l.h};
      host.style.width=l.w+'px';host.style.height=l.h+'px';
    };
    const onUp=()=>{window.removeEventListener('pointermove',onMove);window.removeEventListener('pointerup',onUp);render();queue();};
    window.addEventListener('pointermove',onMove);
    window.addEventListener('pointerup',onUp);
  });
}

function syncInspector(){
  const sec=sectionById(state.selected);
  linkResponsive.disabled=!sec;
  if(!sec){ sectionCard.innerHTML='<h4>Selected section</h4><p class="mini">Pick a section to edit rich controls.</p>'; return; }

  linkResponsive.checked=sec.responsive.linkSpace;
  const c=sec.content;

  sectionCard.innerHTML=`<h4>${sec.type} section</h4>
    <div class='row2'>
      <div class='field'><label>Variant</label>${variantControl(sec)}</div>
      <div class='field'><label>Alignment</label><select id='iAlign'><option ${sel(sec.style.align==='left')}>left</option><option ${sel(sec.style.align==='center')}>center</option><option ${sel(sec.style.align==='right')}>right</option></select></div>
    </div>
    <div class='field'><label><input id='linkType' type='checkbox' ${sec.responsive.linkType?'checked':''}> Link typography across devices</label></div>
    <div class='row3'>
      <div class='field'><label>Space D</label><input id='spD' type='number' min='0' max='140' value='${sec.responsive.space.desktop}'></div>
      <div class='field'><label>Space T</label><input id='spT' type='number' min='0' max='140' value='${sec.responsive.space.tablet}'></div>
      <div class='field'><label>Space M</label><input id='spM' type='number' min='0' max='140' value='${sec.responsive.space.mobile}'></div>
    </div>
    <div class='row3'>
      <div class='field'><label>Type D</label><input id='tyD' type='number' step='0.05' min='0.7' max='1.8' value='${sec.responsive.font.desktop}'></div>
      <div class='field'><label>Type T</label><input id='tyT' type='number' step='0.05' min='0.7' max='1.8' value='${sec.responsive.font.tablet}'></div>
      <div class='field'><label>Type M</label><input id='tyM' type='number' step='0.05' min='0.7' max='1.8' value='${sec.responsive.font.mobile}'></div>
    </div>
    <div class='row2'>
      <div class='field'><label>Background</label><input id='iBg' type='color' value='${hex(sec.style.bg)}'></div>
      <div class='field'><label>Text</label><input id='iFg' type='color' value='${hex(sec.style.fg)}'></div>
      <div class='field'><label>Radius</label><input id='iRadius' type='number' min='0' max='40' value='${sec.style.radius}'></div>
      <div class='field'><label>Image width %</label><input id='iImgW' type='number' min='20' max='100' value='${sec.style.imgW||100}'></div>
      <div class='field'><label>Image fit</label><select id='iFit'><option ${sel(sec.style.fit==='cover')}>cover</option><option ${sel(sec.style.fit==='contain')}>contain</option></select></div>
      <div class='field'><label>CTA style</label><select id='iCta'><option ${sel(sec.style.ctaStyle==='solid')}>solid</option><option ${sel(sec.style.ctaStyle==='outline')}>outline</option></select></div>
    </div>
    <div class='field'><label>Upload media</label><input id='iUpload' type='file' accept='image/*'></div>
    ${contentControls(sec,c)}
  `;

  const by=id=>document.getElementById(id);
  by('iAlign').oninput=e=>mutate(()=>sec.style.align=e.target.value);
  by('linkType').onchange=e=>mutate(()=>sec.responsive.linkType=e.target.checked);
  ['spD','spT','spM'].forEach((id,idx)=>by(id).oninput=e=>mutate(()=>sec.responsive.space[DEVICE_ORDER[idx]]=+e.target.value||0));
  ['tyD','tyT','tyM'].forEach((id,idx)=>by(id).oninput=e=>mutate(()=>sec.responsive.font[DEVICE_ORDER[idx]]=+e.target.value||1));
  by('iBg').oninput=e=>mutate(()=>sec.style.bg=e.target.value);
  by('iFg').oninput=e=>mutate(()=>sec.style.fg=e.target.value);
  by('iRadius').oninput=e=>mutate(()=>sec.style.radius=+e.target.value||0);
  by('iImgW').oninput=e=>mutate(()=>sec.style.imgW=+e.target.value||100);
  by('iFit').oninput=e=>mutate(()=>sec.style.fit=e.target.value);
  by('iCta').oninput=e=>mutate(()=>sec.style.ctaStyle=e.target.value);
  by('iVariant') && (by('iVariant').oninput=e=>mutate(()=>sec.variant=e.target.value));

  const up=by('iUpload');
  if(up) up.onchange=e=>fileToData(e.target.files?.[0],src=>mutate(()=>{ if(sec.type==='gallery') sec.content.items.push(src); else {sec.content.img=src;} }));

  document.querySelectorAll('#sectionCard [data-c]').forEach(el=>el.oninput=()=>mutate(()=>sec.content[el.dataset.c]=el.type==='checkbox'?el.checked:el.value));
}

function mutate(fn){pushHist();fn();render();queue()}
function sel(v){return v?'selected':''}

function variantControl(sec){
  const map={
    header:['minimal','centered'],hero:['split-right','split-left','background'],feature:['cards-2','cards-3','cards-4'],story:['longform','compact'],split:['image-right','image-left'],quote:['center','left'],gallery:['two-up','three-up','four-up'],cta:['center','inline'],footer:['columns','simple']
  };
  const arr=map[sec.type]||['default'];
  return `<select id='iVariant'>${arr.map(v=>`<option ${sel(sec.variant===v)}>${v}</option>`).join('')}</select>`;
}

function contentControls(sec,c){
  if(sec.type==='header') return `<div class='field'><label>Brand</label><input data-c='brand' value='${esc(c.brand)}'></div><div class='field'><label>Nav links (comma)</label><input data-c='links' value='${esc(c.links)}'></div><div class='field'><label>CTA</label><input data-c='cta' value='${esc(c.cta)}'></div>`;
  if(sec.type==='hero') return `<div class='field'><label>Eyebrow</label><input data-c='eyebrow' value='${esc(c.eyebrow)}'></div><div class='field'><label>Primary CTA</label><input data-c='cta' value='${esc(c.cta)}'></div><div class='field'><label>Secondary CTA</label><input data-c='cta2' value='${esc(c.cta2)}'></div>`;
  if(sec.type==='feature') return `<div class='field'><label>Section title</label><input data-c='title' value='${esc(c.title)}'></div><div class='field'><label>Items (| separated)</label><input data-c='items' value='${esc(c.items)}'></div>`;
  if(sec.type==='story') return `<div class='field'><label>Title</label><input data-c='title' value='${esc(c.title)}'></div><div class='field'><label>Body</label><textarea data-c='body'>${esc(c.body)}</textarea></div>`;
  if(sec.type==='split') return `<div class='field'><label>Title</label><input data-c='title' value='${esc(c.title)}'></div><div class='field'><label>Body</label><textarea data-c='body'>${esc(c.body)}</textarea></div><div class='field'><label><input type='checkbox' data-c='swap' ${c.swap?'checked':''}> Swap sides</label></div>`;
  if(sec.type==='quote') return `<div class='field'><label>Quote</label><textarea data-c='quote'>${esc(c.quote)}</textarea></div><div class='field'><label>Author</label><input data-c='author' value='${esc(c.author)}'></div>`;
  if(sec.type==='gallery') return `<div class='mini'>Add images via upload. Current items: ${(c.items||[]).length}</div>`;
  if(sec.type==='cta') return `<div class='field'><label>Title</label><input data-c='title' value='${esc(c.title)}'></div><div class='field'><label>Subtext</label><input data-c='sub' value='${esc(c.sub)}'></div><div class='field'><label>CTA</label><input data-c='cta' value='${esc(c.cta)}'></div>`;
  if(sec.type==='footer') return `<div class='field'><label>Brand</label><input data-c='brand' value='${esc(c.brand)}'></div><div class='field'><label>Text</label><input data-c='text' value='${esc(c.text)}'></div><div class='field'><label>Links (|)</label><input data-c='links' value='${esc(c.links)}'></div><div class='field'><label>Social (comma)</label><input data-c='social' value='${esc(c.social)}'></div>`;
  return '';
}

function fileToData(f,cb){if(!f)return;const r=new FileReader();r.onload=()=>cb(r.result);r.readAsDataURL(f)}

function syncTop(){
  seoTitle.value=state.seo.title;seoDesc.value=state.seo.description;seoOg.value=state.seo.og;
  tkBg.value=hex(state.tokens.bg);tkPanel.value=hex(state.tokens.panel);tkText.value=hex(state.tokens.text);tkAccent.value=hex(state.tokens.accent);
  tkType.value=state.tokens.typeScale;tkSpace.value=state.tokens.spacing;tkMax.value=state.tokens.maxWidth;tkRadius.value=state.tokens.radius;tkShadow.checked=state.tokens.shadow;
  modeBtn.textContent='Mode: '+(state.mode==='draft'?'Draft':'Published');
  toolModeBtn.textContent='Tool: '+(state.toolMode==='edit'?'Edit':'Move/Resize');
  snapBtn.textContent='Snap: '+(state.snapToGrid?'On':'Off');
}

function syncDeviceButtons(){document.querySelectorAll('#deviceSwitch button').forEach(b=>b.classList.toggle('active',b.dataset.d===state.device))}

function addSectionByType(type){if(!type)return;mutate(()=>{state.sections.push(mk(type));state.selected=state.sections.at(-1).id})}
function loadPreset(name){
  const map={
    campaign:['header','hero','feature','split','cta','footer'],
    journal:['header','hero','story','story','quote','footer'],
    studio:['header','hero','feature','gallery','cta','footer']
  };
  const arr=map[name];if(!arr)return;
  mutate(()=>{state.sections=arr.map(mk);state.selected=state.sections[1]?.id||state.sections[0]?.id||null});
}
function duplicateSelected(){
  const s=sectionById(state.selected);if(!s)return;
  const i=state.sections.findIndex(x=>x.id===s.id);
  mutate(()=>{state.sections.splice(i+1,0,deep({...s,id:uid()}));state.selected=state.sections[i+1].id});
}

function exported(){
  const css=`body{margin:0;background:${state.tokens.bg};color:${state.tokens.text};font-family:Inter,system-ui,sans-serif}.wrap{max-width:${state.tokens.maxWidth}px;margin:0 auto;padding:24px}.blk{background:${state.tokens.panel};border-radius:${state.tokens.radius}px;padding:24px;margin:12px 0}`;
  const body=state.sections.map(s=>`<section class='blk'><h3>${s.type.toUpperCase()}</h3></section>`).join('');
  return `<!doctype html><html><head><meta charset='utf-8'><title>${esc(state.seo.title)}</title><meta name='description' content='${esc(state.seo.description)}'><meta property='og:image' content='${esc(state.seo.og)}'><style>${css}</style></head><body><main class='wrap'>${body}</main></body></html>`;
}

function publish(){
  mutate(()=>{
    state.published=deep({sections:state.sections,seo:state.seo,tokens:state.tokens,at:new Date().toISOString()});
    state.mode='published';
  });
  saveSilent('Published local ‚úÖ');
}

function reusableLoad(){try{return JSON.parse(localStorage.getItem(REUSABLE))||[]}catch{return[]}}
function reusableSave(arr){localStorage.setItem(REUSABLE,JSON.stringify(arr))}
function loadReusableChoices(){
  const lib=reusableLoad();
  insertReusable.innerHTML='<option value="">Insert reusable</option>'+lib.map((b,i)=>`<option value='${i}'>${esc(b.name)} (${b.type})</option>`).join('');
}

document.getElementById('addSection').onchange=e=>{addSectionByType(e.target.value);e.target.value=''};
document.getElementById('layoutPreset').onchange=e=>{loadPreset(e.target.value);e.target.value=''};
saveReusable.onclick=()=>{
  const sec=sectionById(state.selected);if(!sec)return status('Select a section first');
  const name=prompt('Reusable name?',sec.type+' module');if(!name)return;
  const lib=reusableLoad();lib.push({name,type:sec.type,data:deep(sec)});reusableSave(lib);loadReusableChoices();status('Reusable saved','ok');
};
insertReusable.onchange=e=>{
  if(e.target.value==='')return;
  const lib=reusableLoad();const item=lib[+e.target.value];if(!item)return;
  mutate(()=>{state.sections.push({...deep(item.data),id:uid()});state.selected=state.sections.at(-1).id});
  e.target.value='';
};

save.onclick=()=>saveSilent('Saved local ‚úÖ');
publishBtn.onclick=publish;
modeBtn.onclick=()=>{state.mode=state.mode==='draft'?'published':'draft';render();saveSilent('Mode switched')};
toolModeBtn.onclick=()=>mutate(()=>state.toolMode=state.toolMode==='edit'?'move':'edit');
snapBtn.onclick=()=>mutate(()=>state.snapToGrid=!state.snapToGrid);
undo.onclick=()=>{if(!history.length)return;future.push(JSON.stringify(state));state=JSON.parse(history.pop());render();saveSilent('Undo')};
redo.onclick=()=>{if(!future.length)return;history.push(JSON.stringify(state));state=JSON.parse(future.pop());render();saveSilent('Redo')};
zoomIn.onclick=()=>{state.zoom=Math.min(1.6,+(state.zoom+0.1).toFixed(2));render()};
zoomOut.onclick=()=>{state.zoom=Math.max(0.6,+(state.zoom-0.1).toFixed(2));render()};
copyBtn.onclick=async()=>{await navigator.clipboard.writeText(exported());status('Export copied','ok')};
exportBtn.onclick=()=>{const blob=new Blob([exported()],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='msj-export.html';a.click();URL.revokeObjectURL(a.href)};

linkResponsive.onchange=e=>{const sec=sectionById(state.selected);if(!sec)return;mutate(()=>sec.responsive.linkSpace=e.target.checked)};

['seoTitle','seoDesc','seoOg'].forEach(id=>window[id].oninput=()=>mutate(()=>{state.seo.title=seoTitle.value;state.seo.description=seoDesc.value;state.seo.og=seoOg.value;}));
['tkBg','tkPanel','tkText','tkAccent','tkType','tkSpace','tkMax','tkRadius','tkShadow'].forEach(id=>window[id].oninput=()=>mutate(()=>{
  state.tokens.bg=tkBg.value;state.tokens.panel=tkPanel.value;state.tokens.text=tkText.value;state.tokens.accent=tkAccent.value;
  state.tokens.typeScale=+tkType.value||1;state.tokens.spacing=+tkSpace.value||1;state.tokens.maxWidth=+tkMax.value||1120;state.tokens.radius=+tkRadius.value||14;state.tokens.shadow=tkShadow.checked;
}));

document.querySelectorAll('[data-token-preset]').forEach(btn=>btn.onclick=()=>mutate(()=>state.tokens=deep(PRESET_TOKENS[btn.dataset.tokenPreset])));
document.querySelectorAll('#deviceSwitch button').forEach(btn=>btn.onclick=()=>{state.device=btn.dataset.d;render()});
document.querySelectorAll('.rail-btn').forEach(btn=>btn.onclick=()=>{
  state.railPanel=btn.dataset.panel;
  document.querySelectorAll('.rail-btn').forEach(x=>x.classList.toggle('active',x===btn));
  updateRailPanel();
});

document.addEventListener('keydown',e=>{
  const mod=e.metaKey||e.ctrlKey;
  if(mod&&e.key.toLowerCase()==='s'){e.preventDefault();saveSilent('Saved local ‚úÖ')}
  if(mod&&e.key.toLowerCase()==='d'){e.preventDefault();duplicateSelected()}
});

const THEME_KEY='msj_editor_theme';
function applyTheme(mode){
  const m=(mode==='dark')?'dark':'light';
  document.body.classList.toggle('dark',m==='dark');
  themeToggle.textContent=m==='dark'?'‚òÄÔ∏è Day':'üåô Night';
  localStorage.setItem(THEME_KEY,m);
}
themeToggle.onclick=()=>applyTheme(document.body.classList.contains('dark')?'light':'dark');
applyTheme(localStorage.getItem(THEME_KEY)||'light');

render();
</script>
</body>
</html>
