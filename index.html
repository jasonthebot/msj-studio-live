<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>msj-studio • Builder Shell</title>
  <style>
    :root{
      --bg:#0a0c10;--shell:#0f1319;--panel:#121821;--panel-2:#171f2b;--line:#242d3b;--line-2:#2f3b4f;
      --text:#edf2ff;--muted:#8e9ab3;--accent:#6f96ff;--accent-2:#8ab0ff;--good:#63d6a2;
      --canvas:#090d14;--overlay:rgba(111,150,255,.18);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(circle at 18% -20%,#1f2b41,var(--bg) 44%);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,sans-serif;overflow:hidden}
    button,select,input,textarea{font:inherit;color:var(--text);background:var(--panel-2);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    button{cursor:pointer;transition:.18s ease} button:hover{border-color:var(--accent)}

    .app{height:100vh;display:grid;grid-template-columns:88px 1fr 380px;grid-template-rows:64px 1fr;background:var(--shell)}

    .rail{grid-row:1/3;background:#0b1017;border-right:1px solid var(--line);padding:12px 10px;display:flex;flex-direction:column;gap:14px}
    .rail .logo{height:40px;display:grid;place-items:center;border:1px solid var(--line);border-radius:12px;background:#121a26;font-weight:700;letter-spacing:.08em}
    .rail-nav{display:flex;flex-direction:column;gap:8px}
    .rail-btn{display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px 6px;font-size:.74rem;color:#b6c2d9;background:transparent;border:1px solid transparent;border-radius:12px}
    .rail-btn.active{background:#162338;border-color:#34507f;color:#e9f0ff}

    .topbar{grid-column:2/4;height:64px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px;padding:10px 16px;background:rgba(12,16,24,.94)}
    .context{font-size:.88rem;color:#b8c4dc;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#121927}
    .seg,.cluster{display:flex;align-items:center;gap:8px;padding-right:12px;border-right:1px solid #253043}
    .cluster:last-of-type{border-right:0}
    .grow{margin-left:auto}
    .pill button{padding:7px 10px;font-size:.78rem}
    .pill button.active{background:#243654;border-color:#3e5d93}
    .primary{background:linear-gradient(180deg,#36518a,#2a416f);border-color:#4d6ea8}
    .publish{background:linear-gradient(180deg,#2e3650,#252c42);border-color:#4f5f87}
    #status{font-size:.8rem;color:var(--muted);min-width:90px;text-align:right}
    #status.ok{color:var(--good)}

    .stage{grid-column:2;grid-row:2;display:grid;grid-template-rows:auto 1fr;background:var(--canvas)}
    .create-strip{padding:10px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;background:#0f1622}
    .create-strip select{min-width:170px}

    .canvas-zone{padding:20px;overflow:auto;position:relative}
    .canvas-center{display:flex;justify-content:center;min-height:100%}
    .preview-frame{width:min(100%,1240px);transition:.2s ease;transform-origin:top center}
    .preview-frame[data-device="tablet"]{width:min(100%,900px)}
    .preview-frame[data-device="mobile"]{width:min(100%,440px)}
    .site{background:#0d131d;border:1px dashed #223048;border-radius:16px;overflow:hidden;padding:8px}

    .blk{border:1px solid #2a364b80;position:relative;transition:.15s ease;margin:12px;border-radius:12px}
    .blk:hover{border-color:#48628e}
    .blk.sel{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent),0 0 0 4px var(--overlay) inset}
    .blk.sel::before{content:'Selected';position:absolute;left:10px;top:-10px;background:#162544;border:1px solid #4164a1;color:#dbe6ff;border-radius:999px;padding:2px 8px;font-size:.68rem;z-index:4}
    .blk-tools{position:absolute;top:8px;right:8px;display:flex;gap:4px;background:#101929e8;padding:4px;border:1px solid #2a3953;border-radius:10px;z-index:5}
    .blk-tools button{padding:3px 7px;font-size:.72rem}
    .ed{outline:none}.ed:focus{box-shadow:0 0 0 2px #7aa2ff70;border-radius:6px}

    .inspector{grid-column:3;grid-row:2;border-left:1px solid var(--line);background:#0f141d;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:12px}
    .inspector h3{margin:2px 0 0;font-size:.78rem;text-transform:uppercase;letter-spacing:.13em;color:#c4d0e7}
    .panel{border:1px solid var(--line);background:var(--panel);border-radius:12px;padding:12px}
    .panel h4{margin:0 0 10px;font-size:.74rem;text-transform:uppercase;letter-spacing:.1em;color:#b4c1d8}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{margin-bottom:10px}.field:last-child{margin-bottom:0}
    .field label{display:block;font-size:.78rem;color:var(--muted);margin-bottom:5px}
    .mini{font-size:.78rem;color:var(--muted);line-height:1.45}
    .chip{padding:2px 8px;background:#1a2335;border:1px solid var(--line);border-radius:999px;font-size:.73rem}

    @media (max-width:1320px){.app{grid-template-columns:76px 1fr}.topbar{grid-column:2}.inspector{position:fixed;right:0;top:64px;bottom:0;width:360px;z-index:20}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="rail">
      <div class="logo">MSJ</div>
      <nav class="rail-nav">
        <button class="rail-btn active" data-section="create">＋<span>Create</span></button>
        <button class="rail-btn" data-section="content">▦<span>Content</span></button>
        <button class="rail-btn" data-section="theme">◐<span>Theme</span></button>
        <button class="rail-btn" data-section="settings">⚙<span>Settings</span></button>
      </nav>
    </aside>

    <header class="topbar">
      <div class="context">Page: Home / Default Template</div>
      <div class="seg pill" id="deviceSwitchTop">
        <button data-d="desktop">Desktop</button><button data-d="tablet">Tablet</button><button data-d="mobile">Mobile</button>
      </div>
      <div class="cluster">
        <button id="zoomOut">−</button><span class="mini" id="zoomLabel">100%</span><button id="zoomIn">＋</button>
      </div>
      <div class="cluster">
        <button id="undo">Undo</button><button id="redo">Redo</button>
      </div>
      <div class="cluster grow">
        <button id="copyBtn">Copy export</button><button id="exportBtn">Export</button>
      </div>
      <button id="save" class="primary">Save</button>
      <button id="publishBtn" class="publish">Publish</button>
      <button id="modeBtn">Mode: Draft</button>
      <div id="status">Ready</div>
    </header>

    <main class="stage">
      <div class="create-strip" id="createStrip">
        <select id="addBlock" title="Add block">
          <option value="">+ Add block</option>
          <option value="header">Header/Nav</option><option value="hero">Hero</option><option value="text">Text</option>
          <option value="image">Image</option><option value="split">Split</option><option value="gallery">Gallery</option><option value="footer">Footer</option>
        </select>
        <select id="templatePick" title="Switch template"><option value="">Templates</option><option value="saas">SaaS</option><option value="portfolio">Portfolio</option><option value="landing">Landing</option></select>
      </div>
      <div class="canvas-zone">
        <div class="canvas-center">
          <div class="preview-frame" id="previewFrame" data-device="desktop">
            <div class="site" id="site"></div>
          </div>
        </div>
      </div>
    </main>

    <aside class="inspector">
      <h3>Inspector</h3>
      <section class="panel">
        <h4>Editing scope</h4>
        <div class="field"><label><input id="applyAllDevices" type="checkbox" checked> Apply to all devices</label></div>
        <div class="mini">Turn off to edit Tablet/Mobile styles independently for selected blocks.</div>
      </section>

      <section class="panel" id="settingsPanel">
        <h4>Project settings</h4>
        <div class="field"><label>SEO title</label><input id="seoTitle"/></div>
        <div class="field"><label>Meta description</label><textarea id="seoDesc" rows="2"></textarea></div>
        <div class="field"><label>OG image URL</label><input id="seoOg"/></div>
      </section>

      <section class="panel" id="themePanel">
        <h4>Theme system</h4>
        <div class="row2">
          <div class="field"><label>Type scale</label><input id="gType" type="number" step="0.05" min="0.7" max="1.5"></div>
          <div class="field"><label>Spacing</label><input id="gSpace" type="number" step="0.05" min="0.7" max="1.8"></div>
          <div class="field"><label>Max width</label><input id="gMax" type="number" min="760" max="1440"></div>
          <div class="field"><label>Radius</label><input id="gRadius" type="number" min="0" max="40"></div>
        </div>
        <div class="field"><label><input id="gShadow" type="checkbox"> soft shadows</label></div>
      </section>

      <section class="panel" id="blockCard"><h4>Selected block</h4><p class="mini">Pick a block to edit content/style.</p></section>
      <section class="panel"><div class="mini">Duplicate selected block with <strong>⌘/Ctrl+D</strong>. Device-aware editing is preserved.</div></section>
    </aside>
  </div>

<script>
const STORE='msj_beta_v1';
const deep=v=>JSON.parse(JSON.stringify(v));
const uid=()=>crypto.randomUUID();
const initial=()=>({
  mode:'draft',device:'desktop',selected:null,zoom:1,
  seo:{title:'msj-studio site',description:'Built in msj-studio',og:''},
  global:{typeScale:1,spacing:1,maxWidth:1120,radius:14,shadow:true},
  published:null,
  blocks:[mk('header'),mk('hero'),mk('text'),mk('footer')]
});
function mk(type){
  const base={id:uid(),type,linkStyles:true,style:{global:{bg:'#111722',fg:'#edf1f8',pad:24,align:'left',radius:12,fit:'cover',imgW:100},tablet:{},mobile:{}}};
  if(type==='header')return {...base,content:{logo:'MSJ',title:'msj-studio',titleOn:true,logoPos:'left',links:'Features,Pricing,Docs',cta:'Get Started'}};
  if(type==='hero')return {...base,content:{preset:'split-right',headline:'Build sites at speed',sub:'Dark minimal builder with local-first flow.',btn:'Start now',img:''}};
  if(type==='text')return {...base,content:{title:'Section title',body:'Write your copy here.',align:'left'}};
  if(type==='image')return {...base,content:{src:'',alt:'',caption:'',align:'center'}};
  if(type==='split')return {...base,content:{title:'Split block',body:'Text and media side by side.',src:'',swap:false}};
  if(type==='gallery')return {...base,content:{items:[]}};
  if(type==='footer')return {...base,content:{logo:'MSJ',text:'© 2026 msj-studio',social:'X,GitHub,LinkedIn',cols:'Product|About|Contact'}};
}
let state=load()||initial(); if(!state.zoom) state.zoom=1;
let history=[]; let future=[]; let autosave;
function load(){try{return JSON.parse(localStorage.getItem(STORE))}catch{return null}}
function persist(silent=true){localStorage.setItem(STORE,JSON.stringify(state));status(silent?'Autosaved':'Saved local ✅', 'ok');}
function status(t,c=''){const e=document.getElementById('status');e.textContent=t;e.className=c;}
function pushHist(){history.push(JSON.stringify(state)); if(history.length>80)history.shift(); future=[];}
function queue(){clearTimeout(autosave);status('Editing…');autosave=setTimeout(()=>persist(true),450)}
function blocksActive(){return state.mode==='draft'?state.blocks:(state.published?.blocks||state.blocks)}
function styleFor(b){const g=b.style.global||{}; if(b.linkStyles)return g; return {...g,...(b.style[state.device]||{})}}
function updateStyle(b,key,val){if(b.linkStyles||state.device==='desktop') b.style.global[key]=val; else {b.style[state.device]=b.style[state.device]||{}; b.style[state.device][key]=val;}}
function esc(s=''){return s.replace(/[&<>\"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]))}

function render(){
  const frame=document.getElementById('previewFrame');
  frame.dataset.device=state.device;
  frame.style.transform=`scale(${state.zoom})`;
  document.getElementById('zoomLabel').textContent=Math.round(state.zoom*100)+'%';
  const site=document.getElementById('site');
  site.style.maxWidth=state.global.maxWidth+'px'; site.style.margin='0 auto';
  const arr=blocksActive();
  site.innerHTML=arr.map((b,i)=>renderBlock(b,i)).join('');
  bindInline(); syncInspector(); syncDeviceButtons();
}
function renderBlock(b,i){
  const s=styleFor(b), sh=state.global.shadow?'box-shadow:0 10px 25px #00000040;':'';
  const common=`background:${s.bg};color:${s.fg};padding:${(s.pad||22)*state.global.spacing}px;border-radius:${state.global.radius}px;${sh};text-align:${s.align||'left'};`;
  let html='';
  if(b.type==='header'){
    const links=b.content.links.split(',').map(x=>`<span class='chip'>${esc(x.trim())}</span>`).join('');
    html=`<div style='display:flex;align-items:center;justify-content:space-between;gap:12px;flex-direction:${b.content.logoPos==='center'?'column':'row'}'>
      <div style='display:flex;align-items:center;gap:8px'><strong>${esc(b.content.logo)}</strong>${b.content.titleOn?`<span>${esc(b.content.title)}</span>`:''}</div>
      <div style='display:flex;gap:7px;flex-wrap:wrap'>${links}<button>${esc(b.content.cta)}</button></div></div>`;
  }
  if(b.type==='hero'){
    const img=b.content.img?`<img src='${esc(b.content.img)}' style='width:100%;max-height:320px;object-fit:${s.fit||'cover'};border-radius:${state.global.radius}px'>`:'';
    const text=`<div><h1 class='ed' contenteditable='${state.mode==='draft'}' data-f='headline' data-id='${b.id}' style='font-size:${2.1*state.global.typeScale}rem;margin:0 0 8px'>${esc(b.content.headline)}</h1><p class='ed' contenteditable='${state.mode==='draft'}' data-f='sub' data-id='${b.id}'>${esc(b.content.sub)}</p><button>${esc(b.content.btn)}</button></div>`;
    if(b.content.preset==='background'&&b.content.img) html=`<div style='background:url(${esc(b.content.img)}) center/cover;padding:40px;border-radius:${state.global.radius}px'>${text}</div>`;
    else html=`<div style='display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:center'>${b.content.preset==='split-left'?img+text:text+img}</div>`;
  }
  if(b.type==='text') html=`<h2 class='ed' contenteditable='${state.mode==='draft'}' data-f='title' data-id='${b.id}' style='margin:0 0 8px;font-size:${1.45*state.global.typeScale}rem'>${esc(b.content.title)}</h2><p class='ed' contenteditable='${state.mode==='draft'}' data-f='body' data-id='${b.id}'>${esc(b.content.body)}</p>`;
  if(b.type==='image') html=`<div style='text-align:${b.content.align}'><img src='${esc(b.content.src||'')}' style='width:${s.imgW||100}%;max-width:100%;border-radius:${s.radius||state.global.radius}px;object-fit:${s.fit||'cover'};min-height:120px;background:#1a2434'><div class='mini'>${esc(b.content.caption)}</div></div>`;
  if(b.type==='split') html=`<div style='display:grid;grid-template-columns:1fr 1fr;gap:14px'><div style='order:${b.content.swap?2:1}'><h3>${esc(b.content.title)}</h3><p>${esc(b.content.body)}</p></div><div style='order:${b.content.swap?1:2}'><img src='${esc(b.content.src||'')}' style='width:100%;min-height:140px;object-fit:${s.fit||'cover'};border-radius:${state.global.radius}px;background:#1a2434'></div></div>`;
  if(b.type==='gallery') html=`<div style='display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px'>${(b.content.items||[]).map(src=>`<img src='${esc(src)}' style='width:100%;aspect-ratio:1/1;object-fit:${s.fit||'cover'};border-radius:${state.global.radius}px;background:#1a2434'>`).join('')}</div>`;
  if(b.type==='footer'){
    const cols=b.content.cols.split('|').map(x=>`<div>${esc(x)}</div>`).join('');
    html=`<div style='display:grid;grid-template-columns:1.3fr 1fr 1fr;gap:10px'><div><strong>${esc(b.content.logo)}</strong><p>${esc(b.content.text)}</p></div><div>${cols}</div><div>${b.content.social.split(',').map(x=>`<span class='chip'>${esc(x.trim())}</span>`).join('')}</div></div>`;
  }
  const tools=state.mode==='draft'?`<div class='blk-tools'><button data-a='up' data-id='${b.id}'>↑</button><button data-a='down' data-id='${b.id}'>↓</button><button data-a='dup' data-id='${b.id}'>⧉</button><button data-a='del' data-id='${b.id}'>✕</button></div>`:'';
  return `<section class='blk ${state.selected===b.id?'sel':''}' data-id='${b.id}' style='${common}'>${tools}${html}</section>`;
}

function bindInline(){
  document.querySelectorAll('.blk').forEach(el=>el.onclick=(e)=>{if(e.target.closest('button[data-a]'))return; state.selected=el.dataset.id; render();});
  document.querySelectorAll('button[data-a]').forEach(btn=>btn.onclick=(e)=>{e.stopPropagation();const id=btn.dataset.id,a=btn.dataset.a,arr=state.blocks,i=arr.findIndex(b=>b.id===id);if(i<0)return;pushHist();
    if(a==='del')arr.splice(i,1); if(a==='dup')arr.splice(i+1,0,deep({...arr[i],id:uid()})); if(a==='up'&&i>0)[arr[i-1],arr[i]]=[arr[i],arr[i-1]]; if(a==='down'&&i<arr.length-1)[arr[i+1],arr[i]]=[arr[i],arr[i+1]]; state.selected=arr[Math.max(0,i)]?.id||null; render();queue();});
  document.querySelectorAll('.ed').forEach(ed=>ed.oninput=()=>{const b=state.blocks.find(x=>x.id===ed.dataset.id); if(!b)return;pushHist(); b.content[ed.dataset.f]=ed.textContent; queue();});
}

function syncInspector(){
  const b=state.blocks.find(x=>x.id===state.selected);
  const card=document.getElementById('blockCard');
  const apply=document.getElementById('applyAllDevices');
  apply.disabled=!b;
  if(!b){
    apply.checked=true;
    card.innerHTML='<h4>Selected block</h4><p class="mini">Pick a block to edit.</p>';
    return;
  }
  apply.checked=b.linkStyles;
  const s=styleFor(b);
  card.innerHTML=`<h4>${b.type} block</h4>
    <div class='field'><label><input id='linkStyles' type='checkbox' ${b.linkStyles?'checked':''}> link styles across devices</label></div>
    <div class='row2'><div class='field'><label>Background</label><input id='bg' type='color' value='${toHex(s.bg||'#111722')}'></div><div class='field'><label>Text</label><input id='fg' type='color' value='${toHex(s.fg||'#edf1f8')}'></div>
      <div class='field'><label>Padding</label><input id='pad' type='number' min='0' max='120' value='${s.pad||22}'></div><div class='field'><label>Align</label><select id='align'><option ${sel((s.align||'left')==='left')}>left</option><option ${sel((s.align||'left')==='center')}>center</option><option ${sel((s.align||'left')==='right')}>right</option></select></div></div>
    <div class='row2'><div class='field'><label>Image fit</label><select id='fit'><option ${sel((s.fit||'cover')==='cover')}>cover</option><option ${sel((s.fit||'cover')==='contain')}>contain</option></select></div><div class='field'><label>Image width %</label><input id='imgW' type='number' min='20' max='100' value='${s.imgW||100}'></div></div>
    <div class='field'><label>Upload image</label><input id='imgUpload' type='file' accept='image/*'></div>
    ${blockFields(b)}
  `;
  ['bg','fg','pad','align','fit','imgW'].forEach(id=>{const el=document.getElementById(id); if(!el)return; el.oninput=()=>{pushHist();updateStyle(b,idMap(id),id==='pad'||id==='imgW'?Number(el.value):el.value); render();queue();};});
  document.getElementById('linkStyles').onchange=e=>{pushHist();b.linkStyles=e.target.checked;document.getElementById('applyAllDevices').checked=b.linkStyles;render();queue();};
  const up=document.getElementById('imgUpload'); if(up) up.onchange=e=>fileToData(e.target.files?.[0],src=>{pushHist();if(b.type==='gallery') b.content.items.push(src); else b.content.img=src,b.content.src=src; render();queue();});
  bindBlockInputs(b);
}
function idMap(id){return ({bg:'bg',fg:'fg',pad:'pad',align:'align',fit:'fit',imgW:'imgW'})[id]}
function sel(v){return v?'selected':''}
function toHex(c){if(!c)return'#111722';if(c.startsWith('#'))return c;const m=c.match(/\d+/g);return m?'#'+m.slice(0,3).map(n=>(+n).toString(16).padStart(2,'0')).join(''):'#111722'}
function blockFields(b){
  if(b.type==='header')return `<div class='field'><label>Logo</label><input data-k='logo' value='${esc(b.content.logo)}'></div><div class='field'><label>Title</label><input data-k='title' value='${esc(b.content.title)}'></div><div class='row2'><div class='field'><label>Logo position</label><select data-k='logoPos'><option ${sel(b.content.logoPos==='left')}>left</option><option ${sel(b.content.logoPos==='center')}>center</option><option ${sel(b.content.logoPos==='right')}>right</option></select></div><div class='field'><label>CTA</label><input data-k='cta' value='${esc(b.content.cta)}'></div></div><div class='field'><label>Nav links (comma)</label><input data-k='links' value='${esc(b.content.links)}'></div>`;
  if(b.type==='hero')return `<div class='field'><label>Preset</label><select data-k='preset'><option ${sel(b.content.preset==='split-right')}>split-right</option><option ${sel(b.content.preset==='split-left')}>split-left</option><option ${sel(b.content.preset==='background')}>background</option></select></div><div class='field'><label>Button text</label><input data-k='btn' value='${esc(b.content.btn)}'></div>`;
  if(b.type==='text')return `<div class='field'><label>Body</label><textarea data-k='body'>${esc(b.content.body)}</textarea></div>`;
  if(b.type==='image')return `<div class='field'><label>Caption</label><input data-k='caption' value='${esc(b.content.caption)}'></div><div class='field'><label>Align image</label><select data-k='align'><option ${sel(b.content.align==='left')}>left</option><option ${sel(b.content.align==='center')}>center</option><option ${sel(b.content.align==='right')}>right</option></select></div>`;
  if(b.type==='split')return `<div class='field'><label>Title</label><input data-k='title' value='${esc(b.content.title)}'></div><div class='field'><label>Body</label><textarea data-k='body'>${esc(b.content.body)}</textarea></div><div class='field'><label><input data-k='swap' type='checkbox' ${b.content.swap?'checked':''}> swap sides</label></div>`;
  if(b.type==='footer')return `<div class='field'><label>Footer text</label><input data-k='text' value='${esc(b.content.text)}'></div><div class='field'><label>Social links labels</label><input data-k='social' value='${esc(b.content.social)}'></div><div class='field'><label>Columns (|)</label><input data-k='cols' value='${esc(b.content.cols)}'></div>`;
  return '<p class="mini">Gallery: upload multiple images from device.</p>';
}
function bindBlockInputs(b){document.querySelectorAll('#blockCard [data-k]').forEach(el=>el.oninput=()=>{pushHist();const k=el.dataset.k; b.content[k]=el.type==='checkbox'?el.checked:el.value; render();queue();});}
function fileToData(f,cb){if(!f)return;const r=new FileReader();r.onload=()=>cb(r.result);r.readAsDataURL(f)}

addBlock.onchange=e=>{if(!e.target.value)return;pushHist();state.blocks.push(mk(e.target.value));state.selected=state.blocks.at(-1).id;e.target.value='';render();queue();};
templatePick.onchange=e=>{const t=e.target.value;if(!t)return;pushHist();const m={saas:['header','hero','features','gallery','footer'],portfolio:['header','hero','image','split','gallery','footer'],landing:['hero','text','split','footer']};state.blocks=(m[t]||['hero']).map(x=>x==='features'?mk('text'):mk(x));state.selected=state.blocks[0].id;e.target.value='';render();queue();};
save.onclick=()=>persist(false);
undo.onclick=()=>{if(!history.length)return;future.push(JSON.stringify(state));state=JSON.parse(history.pop());render();persist(true)};
redo.onclick=()=>{if(!future.length)return;history.push(JSON.stringify(state));state=JSON.parse(future.pop());render();persist(true)};
modeBtn.onclick=()=>{state.mode=state.mode==='draft'?'published':'draft';modeBtn.textContent='Mode: '+(state.mode==='draft'?'Draft':'Published');render();};
publishBtn.onclick=()=>{state.published=deep({blocks:state.blocks,seo:state.seo,global:state.global,at:new Date().toISOString()});state.mode='published';modeBtn.textContent='Mode: Published';persist(false);render();};
function exported(){const html=blocksToHTML(state.blocks,state);const css=`body{font-family:Inter,system-ui,sans-serif;background:#0b0d12;color:#edf1f8} .wrap{max-width:${state.global.maxWidth}px;margin:0 auto}`;return `<!doctype html><html><head><meta charset='utf-8'><title>${esc(state.seo.title)}</title><meta name='description' content='${esc(state.seo.description)}'><meta property='og:image' content='${esc(state.seo.og)}'><style>${css}</style></head><body><main class='wrap'>${html}</main></body></html>`;}
function blocksToHTML(arr){return arr.map(b=>`<section style="padding:${(b.style.global.pad||20)*state.global.spacing}px;background:${b.style.global.bg};color:${b.style.global.fg};margin:10px;border-radius:${state.global.radius}px">${b.type.toUpperCase()}</section>`).join('')}
exportBtn.onclick=()=>{const blob=new Blob([exported()],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='msj-export.html';a.click();URL.revokeObjectURL(a.href)};
copyBtn.onclick=async()=>{await navigator.clipboard.writeText(exported());status('Export copied', 'ok')};
['seoTitle','seoDesc','seoOg','gType','gSpace','gMax','gRadius','gShadow'].forEach(id=>window[id].oninput=()=>{pushHist();state.seo.title=seoTitle.value;state.seo.description=seoDesc.value;state.seo.og=seoOg.value;state.global.typeScale=+gType.value||1;state.global.spacing=+gSpace.value||1;state.global.maxWidth=+gMax.value||1120;state.global.radius=+gRadius.value||14;state.global.shadow=gShadow.checked;render();queue();});

document.querySelectorAll('#deviceSwitchTop button').forEach(b=>b.onclick=()=>switchDevice(b.dataset.d));
zoomIn.onclick=()=>{state.zoom=Math.min(1.6, +(state.zoom+0.1).toFixed(2)); render();};
zoomOut.onclick=()=>{state.zoom=Math.max(0.6, +(state.zoom-0.1).toFixed(2)); render();};

document.getElementById('applyAllDevices').onchange=e=>{const b=state.blocks.find(x=>x.id===state.selected);if(!b)return;pushHist();b.linkStyles=e.target.checked;render();queue();};

document.addEventListener('keydown',e=>{
  const mod=e.metaKey||e.ctrlKey;
  if(mod&&e.key.toLowerCase()==='s'){e.preventDefault();persist(false);}
  if(mod&&e.key.toLowerCase()==='d'){e.preventDefault();duplicateSelected();}
});

function duplicateSelected(){
  const id=state.selected; if(!id) return;
  const arr=state.blocks; const i=arr.findIndex(b=>b.id===id); if(i<0) return;
  pushHist(); arr.splice(i+1,0,deep({...arr[i],id:uid()})); state.selected=arr[i+1].id; render(); queue(); status('Block duplicated', 'ok');
}

function switchDevice(next){ if(!next||next===state.device)return; state.device=next; render(); }
function syncDeviceButtons(){ document.querySelectorAll('#deviceSwitchTop button').forEach(btn=>btn.classList.toggle('active',btn.dataset.d===state.device)); }

function syncTop(){seoTitle.value=state.seo.title;seoDesc.value=state.seo.description;seoOg.value=state.seo.og;gType.value=state.global.typeScale;gSpace.value=state.global.spacing;gMax.value=state.global.maxWidth;gRadius.value=state.global.radius;gShadow.checked=state.global.shadow;modeBtn.textContent='Mode: '+(state.mode==='draft'?'Draft':'Published')}

// Left rail section highlighting + panel focus
const sectionToFocus={create:'createStrip',content:'blockCard',theme:'themePanel',settings:'settingsPanel'};
document.querySelectorAll('.rail-btn').forEach(btn=>btn.onclick=()=>{
  document.querySelectorAll('.rail-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
  const id=sectionToFocus[btn.dataset.section]; const el=document.getElementById(id); if(el) el.scrollIntoView({behavior:'smooth',block:'start'});
});

syncTop(); render();
</script>
</body>
</html>